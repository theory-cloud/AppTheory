"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppTheoryLambdaRole = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const iam = require("aws-cdk-lib/aws-iam");
const constructs_1 = require("constructs");
/**
 * A Lambda execution role construct with baseline permissions and optional enhancements.
 *
 * Creates an IAM role suitable for Lambda execution with:
 * - Basic Lambda execution permissions (CloudWatch Logs)
 * - Optional X-Ray tracing permissions
 * - Optional KMS permissions for environment encryption
 * - Optional KMS permissions for application-level encryption
 * - Escape hatch for additional inline policy statements
 *
 * @example
 * const role = new AppTheoryLambdaRole(this, 'LambdaRole', {
 *   roleName: 'my-lambda-role',
 *   enableXRay: true,
 *   environmentEncryptionKeys: [envKey],
 *   applicationKmsKeys: [dataKey],
 *   additionalStatements: [
 *     new iam.PolicyStatement({
 *       actions: ['s3:GetObject'],
 *       resources: ['arn:aws:s3:::my-bucket/*'],
 *     }),
 *   ],
 * });
 */
class AppTheoryLambdaRole extends constructs_1.Construct {
    constructor(scope, id, props = {}) {
        super(scope, id);
        const enableXRay = props.enableXRay ?? false;
        // Create the base Lambda execution role
        this.role = new iam.Role(this, "Role", {
            roleName: props.roleName,
            description: props.description ?? "Lambda execution role created by AppTheory",
            assumedBy: new iam.ServicePrincipal("lambda.amazonaws.com"),
        });
        // Attach baseline Lambda execution managed policy (CloudWatch Logs permissions)
        this.role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AWSLambdaBasicExecutionRole"));
        // Optional: X-Ray tracing permissions
        if (enableXRay) {
            this.role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName("AWSXRayDaemonWriteAccess"));
        }
        // Optional: KMS permissions for environment variable encryption
        if (props.environmentEncryptionKeys && props.environmentEncryptionKeys.length > 0) {
            const envKeyArns = props.environmentEncryptionKeys.map((key) => key.keyArn);
            this.role.addToPolicy(new iam.PolicyStatement({
                sid: "AllowEnvironmentDecryption",
                actions: ["kms:Decrypt"],
                resources: envKeyArns,
            }));
        }
        // Optional: KMS permissions for application-level encrypt/decrypt
        if (props.applicationKmsKeys && props.applicationKmsKeys.length > 0) {
            for (const key of props.applicationKmsKeys) {
                key.grantEncryptDecrypt(this.role);
            }
        }
        // Optional: Additional inline policy statements (escape hatch)
        if (props.additionalStatements && props.additionalStatements.length > 0) {
            for (const statement of props.additionalStatements) {
                this.role.addToPolicy(statement);
            }
        }
        // Expose role properties
        this.roleArn = this.role.roleArn;
        this.roleName = this.role.roleName;
        // Apply tags
        aws_cdk_lib_1.Tags.of(this.role).add("Framework", "AppTheory");
        aws_cdk_lib_1.Tags.of(this.role).add("Component", "LambdaRole");
        if (props.tags) {
            for (const [key, value] of Object.entries(props.tags)) {
                aws_cdk_lib_1.Tags.of(this.role).add(key, value);
            }
        }
    }
    /**
     * Grant this role to a grantable principal.
     * This is useful when you need to allow another entity to assume this role.
     */
    grantAssumeRole(grantee) {
        return this.role.grantAssumeRole(grantee);
    }
    /**
     * Grant permissions to pass this role.
     * This is required when a service needs to pass this role to Lambda.
     */
    grantPassRole(grantee) {
        return this.role.grantPassRole(grantee);
    }
    /**
     * Add a managed policy to this role.
     */
    addManagedPolicy(policy) {
        this.role.addManagedPolicy(policy);
    }
    /**
     * Add an inline policy statement to this role.
     */
    addToPolicy(statement) {
        return this.role.addToPolicy(statement);
    }
}
exports.AppTheoryLambdaRole = AppTheoryLambdaRole;
_a = JSII_RTTI_SYMBOL_1;
AppTheoryLambdaRole[_a] = { fqn: "@theory-cloud/apptheory-cdk.AppTheoryLambdaRole", version: "0.9.1" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLXJvbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsYW1iZGEtcm9sZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLDZDQUFtQztBQUNuQywyQ0FBMkM7QUFFM0MsMkNBQXVDO0FBOEN2Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFDSCxNQUFhLG1CQUFvQixTQUFRLHNCQUFTO0lBZ0I5QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLFFBQWtDLEVBQUU7UUFDMUUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsVUFBVSxJQUFJLEtBQUssQ0FBQztRQUU3Qyx3Q0FBd0M7UUFDeEMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRTtZQUNuQyxRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVE7WUFDeEIsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXLElBQUksNENBQTRDO1lBQzlFLFNBQVMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxzQkFBc0IsQ0FBQztTQUM5RCxDQUFDLENBQUM7UUFFSCxnRkFBZ0Y7UUFDaEYsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLHdCQUF3QixDQUFDLDBDQUEwQyxDQUFDLENBQUMsQ0FBQztRQUVuSCxzQ0FBc0M7UUFDdEMsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUNiLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUM7UUFDdkcsQ0FBQztRQUVELGdFQUFnRTtRQUNoRSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2hGLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUM1RSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FDakIsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO2dCQUNwQixHQUFHLEVBQUUsNEJBQTRCO2dCQUNqQyxPQUFPLEVBQUUsQ0FBQyxhQUFhLENBQUM7Z0JBQ3hCLFNBQVMsRUFBRSxVQUFVO2FBQ3hCLENBQUMsQ0FDTCxDQUFDO1FBQ04sQ0FBQztRQUVELGtFQUFrRTtRQUNsRSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsSUFBSSxLQUFLLENBQUMsa0JBQWtCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2xFLEtBQUssTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLGtCQUFrQixFQUFFLENBQUM7Z0JBQ3pDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkMsQ0FBQztRQUNMLENBQUM7UUFFRCwrREFBK0Q7UUFDL0QsSUFBSSxLQUFLLENBQUMsb0JBQW9CLElBQUksS0FBSyxDQUFDLG9CQUFvQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN0RSxLQUFLLE1BQU0sU0FBUyxJQUFJLEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO2dCQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNyQyxDQUFDO1FBQ0wsQ0FBQztRQUVELHlCQUF5QjtRQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7UUFFbkMsYUFBYTtRQUNiLGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2pELGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRWxELElBQUksS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2IsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQ3BELGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3ZDLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNJLGVBQWUsQ0FBQyxPQUF1QjtRQUMxQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRDs7O09BR0c7SUFDSSxhQUFhLENBQUMsT0FBdUI7UUFDeEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7O09BRUc7SUFDSSxnQkFBZ0IsQ0FBQyxNQUEwQjtRQUM5QyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNJLFdBQVcsQ0FBQyxTQUE4QjtRQUM3QyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzVDLENBQUM7O0FBekdMLGtEQTBHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRhZ3MgfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMga21zIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mta21zXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIEFwcFRoZW9yeUxhbWJkYVJvbGUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXBwVGhlb3J5TGFtYmRhUm9sZVByb3BzIHtcbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCByb2xlIG5hbWUuIElmIG5vdCBwcm92aWRlZCwgQ2xvdWRGb3JtYXRpb24gd2lsbCBnZW5lcmF0ZSBhIHVuaXF1ZSBuYW1lLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IHJvbGVOYW1lPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwgZGVzY3JpcHRpb24gZm9yIHRoZSBJQU0gcm9sZS5cbiAgICAgKi9cbiAgICByZWFkb25seSBkZXNjcmlwdGlvbj86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEVuYWJsZSBYLVJheSB0cmFjaW5nIHBlcm1pc3Npb25zIGJ5IGF0dGFjaGluZyBBV1NYUmF5RGFlbW9uV3JpdGVBY2Nlc3MgbWFuYWdlZCBwb2xpY3kuXG4gICAgICogQGRlZmF1bHQgZmFsc2VcbiAgICAgKi9cbiAgICByZWFkb25seSBlbmFibGVYUmF5PzogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIEtNUyBrZXkocykgZm9yIExhbWJkYSBlbnZpcm9ubWVudCB2YXJpYWJsZSBlbmNyeXB0aW9uLlxuICAgICAqIEdyYW50cyB0aGUgcm9sZSBwZXJtaXNzaW9uIHRvIGRlY3J5cHQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGVuY3J5cHRlZCB3aXRoIHRoZXNlIGtleXMuXG4gICAgICovXG4gICAgcmVhZG9ubHkgZW52aXJvbm1lbnRFbmNyeXB0aW9uS2V5cz86IGttcy5JS2V5W107XG5cbiAgICAvKipcbiAgICAgKiBLTVMga2V5KHMpIGZvciBhcHBsaWNhdGlvbi1sZXZlbCBLTVMgdXNhZ2UgKGVuY3J5cHQvZGVjcnlwdCBkYXRhIGF0IHJ1bnRpbWUpLlxuICAgICAqIEdyYW50cyB0aGUgcm9sZSBmdWxsIGVuY3J5cHQvZGVjcnlwdCBwZXJtaXNzaW9ucyBvbiB0aGVzZSBrZXlzLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGFwcGxpY2F0aW9uS21zS2V5cz86IGttcy5JS2V5W107XG5cbiAgICAvKipcbiAgICAgKiBBZGRpdGlvbmFsIGlubGluZSBwb2xpY3kgc3RhdGVtZW50cyB0byBhdHRhY2ggdG8gdGhlIHJvbGUuXG4gICAgICogVXNlIHRoaXMgZXNjYXBlIGhhdGNoIGZvciBhbnkgYWRkaXRpb25hbCBwZXJtaXNzaW9ucyBub3QgY292ZXJlZCBieSB0aGUgY29uc3RydWN0LlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGFkZGl0aW9uYWxTdGF0ZW1lbnRzPzogaWFtLlBvbGljeVN0YXRlbWVudFtdO1xuXG4gICAgLyoqXG4gICAgICogVGFncyB0byBhcHBseSB0byB0aGUgSUFNIHJvbGUuXG4gICAgICovXG4gICAgcmVhZG9ubHkgdGFncz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG59XG5cbi8qKlxuICogQSBMYW1iZGEgZXhlY3V0aW9uIHJvbGUgY29uc3RydWN0IHdpdGggYmFzZWxpbmUgcGVybWlzc2lvbnMgYW5kIG9wdGlvbmFsIGVuaGFuY2VtZW50cy5cbiAqXG4gKiBDcmVhdGVzIGFuIElBTSByb2xlIHN1aXRhYmxlIGZvciBMYW1iZGEgZXhlY3V0aW9uIHdpdGg6XG4gKiAtIEJhc2ljIExhbWJkYSBleGVjdXRpb24gcGVybWlzc2lvbnMgKENsb3VkV2F0Y2ggTG9ncylcbiAqIC0gT3B0aW9uYWwgWC1SYXkgdHJhY2luZyBwZXJtaXNzaW9uc1xuICogLSBPcHRpb25hbCBLTVMgcGVybWlzc2lvbnMgZm9yIGVudmlyb25tZW50IGVuY3J5cHRpb25cbiAqIC0gT3B0aW9uYWwgS01TIHBlcm1pc3Npb25zIGZvciBhcHBsaWNhdGlvbi1sZXZlbCBlbmNyeXB0aW9uXG4gKiAtIEVzY2FwZSBoYXRjaCBmb3IgYWRkaXRpb25hbCBpbmxpbmUgcG9saWN5IHN0YXRlbWVudHNcbiAqXG4gKiBAZXhhbXBsZVxuICogY29uc3Qgcm9sZSA9IG5ldyBBcHBUaGVvcnlMYW1iZGFSb2xlKHRoaXMsICdMYW1iZGFSb2xlJywge1xuICogICByb2xlTmFtZTogJ215LWxhbWJkYS1yb2xlJyxcbiAqICAgZW5hYmxlWFJheTogdHJ1ZSxcbiAqICAgZW52aXJvbm1lbnRFbmNyeXB0aW9uS2V5czogW2VudktleV0sXG4gKiAgIGFwcGxpY2F0aW9uS21zS2V5czogW2RhdGFLZXldLFxuICogICBhZGRpdGlvbmFsU3RhdGVtZW50czogW1xuICogICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAqICAgICAgIGFjdGlvbnM6IFsnczM6R2V0T2JqZWN0J10sXG4gKiAgICAgICByZXNvdXJjZXM6IFsnYXJuOmF3czpzMzo6Om15LWJ1Y2tldC8qJ10sXG4gKiAgICAgfSksXG4gKiAgIF0sXG4gKiB9KTtcbiAqL1xuZXhwb3J0IGNsYXNzIEFwcFRoZW9yeUxhbWJkYVJvbGUgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAgIC8qKlxuICAgICAqIFRoZSB1bmRlcmx5aW5nIElBTSBSb2xlLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSByb2xlOiBpYW0uUm9sZTtcblxuICAgIC8qKlxuICAgICAqIFRoZSBBUk4gb2YgdGhlIElBTSBSb2xlLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSByb2xlQXJuOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbmFtZSBvZiB0aGUgSUFNIFJvbGUuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IHJvbGVOYW1lOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQXBwVGhlb3J5TGFtYmRhUm9sZVByb3BzID0ge30pIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgICAgICBjb25zdCBlbmFibGVYUmF5ID0gcHJvcHMuZW5hYmxlWFJheSA/PyBmYWxzZTtcblxuICAgICAgICAvLyBDcmVhdGUgdGhlIGJhc2UgTGFtYmRhIGV4ZWN1dGlvbiByb2xlXG4gICAgICAgIHRoaXMucm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBcIlJvbGVcIiwge1xuICAgICAgICAgICAgcm9sZU5hbWU6IHByb3BzLnJvbGVOYW1lLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IHByb3BzLmRlc2NyaXB0aW9uID8/IFwiTGFtYmRhIGV4ZWN1dGlvbiByb2xlIGNyZWF0ZWQgYnkgQXBwVGhlb3J5XCIsXG4gICAgICAgICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcImxhbWJkYS5hbWF6b25hd3MuY29tXCIpLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBBdHRhY2ggYmFzZWxpbmUgTGFtYmRhIGV4ZWN1dGlvbiBtYW5hZ2VkIHBvbGljeSAoQ2xvdWRXYXRjaCBMb2dzIHBlcm1pc3Npb25zKVxuICAgICAgICB0aGlzLnJvbGUuYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJzZXJ2aWNlLXJvbGUvQVdTTGFtYmRhQmFzaWNFeGVjdXRpb25Sb2xlXCIpKTtcblxuICAgICAgICAvLyBPcHRpb25hbDogWC1SYXkgdHJhY2luZyBwZXJtaXNzaW9uc1xuICAgICAgICBpZiAoZW5hYmxlWFJheSkge1xuICAgICAgICAgICAgdGhpcy5yb2xlLmFkZE1hbmFnZWRQb2xpY3koaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQVdTWFJheURhZW1vbldyaXRlQWNjZXNzXCIpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE9wdGlvbmFsOiBLTVMgcGVybWlzc2lvbnMgZm9yIGVudmlyb25tZW50IHZhcmlhYmxlIGVuY3J5cHRpb25cbiAgICAgICAgaWYgKHByb3BzLmVudmlyb25tZW50RW5jcnlwdGlvbktleXMgJiYgcHJvcHMuZW52aXJvbm1lbnRFbmNyeXB0aW9uS2V5cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBlbnZLZXlBcm5zID0gcHJvcHMuZW52aXJvbm1lbnRFbmNyeXB0aW9uS2V5cy5tYXAoKGtleSkgPT4ga2V5LmtleUFybik7XG4gICAgICAgICAgICB0aGlzLnJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBzaWQ6IFwiQWxsb3dFbnZpcm9ubWVudERlY3J5cHRpb25cIixcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uczogW1wia21zOkRlY3J5cHRcIl0sXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogZW52S2V5QXJucyxcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBPcHRpb25hbDogS01TIHBlcm1pc3Npb25zIGZvciBhcHBsaWNhdGlvbi1sZXZlbCBlbmNyeXB0L2RlY3J5cHRcbiAgICAgICAgaWYgKHByb3BzLmFwcGxpY2F0aW9uS21zS2V5cyAmJiBwcm9wcy5hcHBsaWNhdGlvbkttc0tleXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgcHJvcHMuYXBwbGljYXRpb25LbXNLZXlzKSB7XG4gICAgICAgICAgICAgICAga2V5LmdyYW50RW5jcnlwdERlY3J5cHQodGhpcy5yb2xlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE9wdGlvbmFsOiBBZGRpdGlvbmFsIGlubGluZSBwb2xpY3kgc3RhdGVtZW50cyAoZXNjYXBlIGhhdGNoKVxuICAgICAgICBpZiAocHJvcHMuYWRkaXRpb25hbFN0YXRlbWVudHMgJiYgcHJvcHMuYWRkaXRpb25hbFN0YXRlbWVudHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZm9yIChjb25zdCBzdGF0ZW1lbnQgb2YgcHJvcHMuYWRkaXRpb25hbFN0YXRlbWVudHMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJvbGUuYWRkVG9Qb2xpY3koc3RhdGVtZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEV4cG9zZSByb2xlIHByb3BlcnRpZXNcbiAgICAgICAgdGhpcy5yb2xlQXJuID0gdGhpcy5yb2xlLnJvbGVBcm47XG4gICAgICAgIHRoaXMucm9sZU5hbWUgPSB0aGlzLnJvbGUucm9sZU5hbWU7XG5cbiAgICAgICAgLy8gQXBwbHkgdGFnc1xuICAgICAgICBUYWdzLm9mKHRoaXMucm9sZSkuYWRkKFwiRnJhbWV3b3JrXCIsIFwiQXBwVGhlb3J5XCIpO1xuICAgICAgICBUYWdzLm9mKHRoaXMucm9sZSkuYWRkKFwiQ29tcG9uZW50XCIsIFwiTGFtYmRhUm9sZVwiKTtcblxuICAgICAgICBpZiAocHJvcHMudGFncykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMocHJvcHMudGFncykpIHtcbiAgICAgICAgICAgICAgICBUYWdzLm9mKHRoaXMucm9sZSkuYWRkKGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR3JhbnQgdGhpcyByb2xlIHRvIGEgZ3JhbnRhYmxlIHByaW5jaXBhbC5cbiAgICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIHlvdSBuZWVkIHRvIGFsbG93IGFub3RoZXIgZW50aXR5IHRvIGFzc3VtZSB0aGlzIHJvbGUuXG4gICAgICovXG4gICAgcHVibGljIGdyYW50QXNzdW1lUm9sZShncmFudGVlOiBpYW0uSVByaW5jaXBhbCk6IGlhbS5HcmFudCB7XG4gICAgICAgIHJldHVybiB0aGlzLnJvbGUuZ3JhbnRBc3N1bWVSb2xlKGdyYW50ZWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdyYW50IHBlcm1pc3Npb25zIHRvIHBhc3MgdGhpcyByb2xlLlxuICAgICAqIFRoaXMgaXMgcmVxdWlyZWQgd2hlbiBhIHNlcnZpY2UgbmVlZHMgdG8gcGFzcyB0aGlzIHJvbGUgdG8gTGFtYmRhLlxuICAgICAqL1xuICAgIHB1YmxpYyBncmFudFBhc3NSb2xlKGdyYW50ZWU6IGlhbS5JUHJpbmNpcGFsKTogaWFtLkdyYW50IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucm9sZS5ncmFudFBhc3NSb2xlKGdyYW50ZWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIG1hbmFnZWQgcG9saWN5IHRvIHRoaXMgcm9sZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgYWRkTWFuYWdlZFBvbGljeShwb2xpY3k6IGlhbS5JTWFuYWdlZFBvbGljeSk6IHZvaWQge1xuICAgICAgICB0aGlzLnJvbGUuYWRkTWFuYWdlZFBvbGljeShwb2xpY3kpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbiBpbmxpbmUgcG9saWN5IHN0YXRlbWVudCB0byB0aGlzIHJvbGUuXG4gICAgICovXG4gICAgcHVibGljIGFkZFRvUG9saWN5KHN0YXRlbWVudDogaWFtLlBvbGljeVN0YXRlbWVudCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5yb2xlLmFkZFRvUG9saWN5KHN0YXRlbWVudCk7XG4gICAgfVxufVxuIl19