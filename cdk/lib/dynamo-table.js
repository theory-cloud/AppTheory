"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppTheoryDynamoTable = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const constructs_1 = require("constructs");
class AppTheoryDynamoTable extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const billingMode = props.billingMode ?? dynamodb.BillingMode.PAY_PER_REQUEST;
        const removalPolicy = props.removalPolicy ?? aws_cdk_lib_1.RemovalPolicy.RETAIN;
        const ttlAttribute = props.timeToLiveAttribute === undefined ? undefined : String(props.timeToLiveAttribute).trim();
        const enablePITR = props.enablePointInTimeRecovery ?? true;
        const encryption = props.encryption ?? dynamodb.TableEncryption.AWS_MANAGED;
        const enableStream = props.enableStream ?? false;
        if (props.timeToLiveAttribute !== undefined && !ttlAttribute) {
            throw new Error("AppTheoryDynamoTable requires timeToLiveAttribute to be a non-empty string when provided");
        }
        if (encryption === dynamodb.TableEncryption.CUSTOMER_MANAGED && !props.encryptionKey) {
            throw new Error("AppTheoryDynamoTable requires encryptionKey when encryption is CUSTOMER_MANAGED");
        }
        const stream = enableStream
            ? (props.streamViewType ?? dynamodb.StreamViewType.NEW_AND_OLD_IMAGES)
            : undefined;
        this.table = new dynamodb.Table(this, "Table", {
            tableName: props.tableName,
            billingMode,
            partitionKey: {
                name: props.partitionKeyName,
                type: props.partitionKeyType ?? dynamodb.AttributeType.STRING,
            },
            sortKey: {
                name: props.sortKeyName,
                type: props.sortKeyType ?? dynamodb.AttributeType.STRING,
            },
            ...(ttlAttribute ? { timeToLiveAttribute: ttlAttribute } : {}),
            removalPolicy,
            deletionProtection: props.deletionProtection,
            pointInTimeRecovery: enablePITR,
            encryption,
            encryptionKey: props.encryptionKey,
            stream,
            ...(billingMode === dynamodb.BillingMode.PROVISIONED
                ? {
                    readCapacity: props.readCapacity ?? 5,
                    writeCapacity: props.writeCapacity ?? 5,
                }
                : {}),
        });
        for (const gsi of props.globalSecondaryIndexes ?? []) {
            this.table.addGlobalSecondaryIndex({
                indexName: gsi.indexName,
                partitionKey: {
                    name: gsi.partitionKeyName,
                    type: gsi.partitionKeyType ?? dynamodb.AttributeType.STRING,
                },
                sortKey: gsi.sortKeyName
                    ? {
                        name: gsi.sortKeyName,
                        type: gsi.sortKeyType ?? dynamodb.AttributeType.STRING,
                    }
                    : undefined,
                projectionType: gsi.projectionType ?? dynamodb.ProjectionType.ALL,
                nonKeyAttributes: gsi.nonKeyAttributes,
                ...(billingMode === dynamodb.BillingMode.PROVISIONED
                    ? {
                        readCapacity: gsi.readCapacity ?? 5,
                        writeCapacity: gsi.writeCapacity ?? 5,
                    }
                    : {}),
            });
        }
        for (const grantee of props.grantReadTo ?? []) {
            this.table.grantReadData(grantee);
        }
        for (const grantee of props.grantWriteTo ?? []) {
            this.table.grantWriteData(grantee);
        }
        for (const grantee of props.grantReadWriteTo ?? []) {
            this.table.grantReadWriteData(grantee);
        }
        if ((props.grantStreamReadTo ?? []).length > 0 && !enableStream) {
            throw new Error("AppTheoryDynamoTable requires enableStream when using grantStreamReadTo");
        }
        for (const grantee of props.grantStreamReadTo ?? []) {
            this.table.grantStreamRead(grantee);
        }
    }
}
exports.AppTheoryDynamoTable = AppTheoryDynamoTable;
_a = JSII_RTTI_SYMBOL_1;
AppTheoryDynamoTable[_a] = { fqn: "@theory-cloud/apptheory-cdk.AppTheoryDynamoTable", version: "0.9.1" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vLXRhYmxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHluYW1vLXRhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNkNBQTRDO0FBQzVDLHFEQUFxRDtBQUdyRCwyQ0FBdUM7QUF1Q3ZDLE1BQWEsb0JBQXFCLFNBQVEsc0JBQVM7SUFHakQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFnQztRQUN4RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLElBQUksUUFBUSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUM7UUFDOUUsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLGFBQWEsSUFBSSwyQkFBYSxDQUFDLE1BQU0sQ0FBQztRQUNsRSxNQUFNLFlBQVksR0FDaEIsS0FBSyxDQUFDLG1CQUFtQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDakcsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLHlCQUF5QixJQUFJLElBQUksQ0FBQztRQUMzRCxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsVUFBVSxJQUFJLFFBQVEsQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDO1FBQzVFLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxZQUFZLElBQUksS0FBSyxDQUFDO1FBRWpELElBQUksS0FBSyxDQUFDLG1CQUFtQixLQUFLLFNBQVMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQzdELE1BQU0sSUFBSSxLQUFLLENBQUMsMEZBQTBGLENBQUMsQ0FBQztRQUM5RyxDQUFDO1FBRUQsSUFBSSxVQUFVLEtBQUssUUFBUSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FB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SUFBSSxLQUFLLENBQUMsWUFBWSxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQy9DLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFDRCxLQUFLLE1BQU0sT0FBTyxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUNuRCxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3pDLENBQUM7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNoRSxNQUFNLElBQUksS0FBSyxDQUFDLHlFQUF5RSxDQUFDLENBQUM7UUFDN0YsQ0FBQztRQUNELEtBQUssTUFBTSxPQUFPLElBQUksS0FBSyxDQUFDLGlCQUFpQixJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQ3BELElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3RDLENBQUM7SUFDSCxDQUFDOztBQTNGSCxvREE0RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZW1vdmFsUG9saWN5IH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBkeW5hbW9kYiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiXCI7XG5pbXBvcnQgdHlwZSAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0IHR5cGUgKiBhcyBrbXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1rbXNcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwVGhlb3J5RHluYW1vVGFibGVHc2lQcm9wcyB7XG4gIHJlYWRvbmx5IGluZGV4TmFtZTogc3RyaW5nO1xuICByZWFkb25seSBwYXJ0aXRpb25LZXlOYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHBhcnRpdGlvbktleVR5cGU/OiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlO1xuICByZWFkb25seSBzb3J0S2V5TmFtZT86IHN0cmluZztcbiAgcmVhZG9ubHkgc29ydEtleVR5cGU/OiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlO1xuICByZWFkb25seSBwcm9qZWN0aW9uVHlwZT86IGR5bmFtb2RiLlByb2plY3Rpb25UeXBlO1xuICByZWFkb25seSBub25LZXlBdHRyaWJ1dGVzPzogc3RyaW5nW107XG4gIHJlYWRvbmx5IHJlYWRDYXBhY2l0eT86IG51bWJlcjtcbiAgcmVhZG9ubHkgd3JpdGVDYXBhY2l0eT86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcHBUaGVvcnlEeW5hbW9UYWJsZVByb3BzIHtcbiAgcmVhZG9ubHkgdGFibGVOYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHBhcnRpdGlvbktleU5hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgcGFydGl0aW9uS2V5VHlwZT86IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGU7XG4gIHJlYWRvbmx5IHNvcnRLZXlOYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHNvcnRLZXlUeXBlPzogZHluYW1vZGIuQXR0cmlidXRlVHlwZTtcbiAgcmVhZG9ubHkgdGltZVRvTGl2ZUF0dHJpYnV0ZT86IHN0cmluZztcbiAgcmVhZG9ubHkgYmlsbGluZ01vZGU/OiBkeW5hbW9kYi5CaWxsaW5nTW9kZTtcbiAgcmVhZG9ubHkgcmVhZENhcGFjaXR5PzogbnVtYmVyO1xuICByZWFkb25seSB3cml0ZUNhcGFjaXR5PzogbnVtYmVyO1xuICByZWFkb25seSByZW1vdmFsUG9saWN5PzogUmVtb3ZhbFBvbGljeTtcbiAgcmVhZG9ubHkgZGVsZXRpb25Qcm90ZWN0aW9uPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgZW5hYmxlUG9pbnRJblRpbWVSZWNvdmVyeT86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGVuY3J5cHRpb24/OiBkeW5hbW9kYi5UYWJsZUVuY3J5cHRpb247XG4gIHJlYWRvbmx5IGVuY3J5cHRpb25LZXk/OiBrbXMuSUtleTtcbiAgcmVhZG9ubHkgZW5hYmxlU3RyZWFtPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgc3RyZWFtVmlld1R5cGU/OiBkeW5hbW9kYi5TdHJlYW1WaWV3VHlwZTtcbiAgcmVhZG9ubHkgZ2xvYmFsU2Vjb25kYXJ5SW5kZXhlcz86IEFwcFRoZW9yeUR5bmFtb1RhYmxlR3NpUHJvcHNbXTtcblxuICByZWFkb25seSBncmFudFJlYWRUbz86IGlhbS5JR3JhbnRhYmxlW107XG4gIHJlYWRvbmx5IGdyYW50V3JpdGVUbz86IGlhbS5JR3JhbnRhYmxlW107XG4gIHJlYWRvbmx5IGdyYW50UmVhZFdyaXRlVG8/OiBpYW0uSUdyYW50YWJsZVtdO1xuICByZWFkb25seSBncmFudFN0cmVhbVJlYWRUbz86IGlhbS5JR3JhbnRhYmxlW107XG59XG5cbmV4cG9ydCBjbGFzcyBBcHBUaGVvcnlEeW5hbW9UYWJsZSBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSB0YWJsZTogZHluYW1vZGIuVGFibGU7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEFwcFRoZW9yeUR5bmFtb1RhYmxlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgYmlsbGluZ01vZGUgPSBwcm9wcy5iaWxsaW5nTW9kZSA/PyBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1Q7XG4gICAgY29uc3QgcmVtb3ZhbFBvbGljeSA9IHByb3BzLnJlbW92YWxQb2xpY3kgPz8gUmVtb3ZhbFBvbGljeS5SRVRBSU47XG4gICAgY29uc3QgdHRsQXR0cmlidXRlID1cbiAgICAgIHByb3BzLnRpbWVUb0xpdmVBdHRyaWJ1dGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IFN0cmluZyhwcm9wcy50aW1lVG9MaXZlQXR0cmlidXRlKS50cmltKCk7XG4gICAgY29uc3QgZW5hYmxlUElUUiA9IHByb3BzLmVuYWJsZVBvaW50SW5UaW1lUmVjb3ZlcnkgPz8gdHJ1ZTtcbiAgICBjb25zdCBlbmNyeXB0aW9uID0gcHJvcHMuZW5jcnlwdGlvbiA/PyBkeW5hbW9kYi5UYWJsZUVuY3J5cHRpb24uQVdTX01BTkFHRUQ7XG4gICAgY29uc3QgZW5hYmxlU3RyZWFtID0gcHJvcHMuZW5hYmxlU3RyZWFtID8/IGZhbHNlO1xuXG4gICAgaWYgKHByb3BzLnRpbWVUb0xpdmVBdHRyaWJ1dGUgIT09IHVuZGVmaW5lZCAmJiAhdHRsQXR0cmlidXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBcHBUaGVvcnlEeW5hbW9UYWJsZSByZXF1aXJlcyB0aW1lVG9MaXZlQXR0cmlidXRlIHRvIGJlIGEgbm9uLWVtcHR5IHN0cmluZyB3aGVuIHByb3ZpZGVkXCIpO1xuICAgIH1cblxuICAgIGlmIChlbmNyeXB0aW9uID09PSBkeW5hbW9kYi5UYWJsZUVuY3J5cHRpb24uQ1VTVE9NRVJfTUFOQUdFRCAmJiAhcHJvcHMuZW5jcnlwdGlvbktleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXBwVGhlb3J5RHluYW1vVGFibGUgcmVxdWlyZXMgZW5jcnlwdGlvbktleSB3aGVuIGVuY3J5cHRpb24gaXMgQ1VTVE9NRVJfTUFOQUdFRFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJlYW0gPSBlbmFibGVTdHJlYW1cbiAgICAgID8gKHByb3BzLnN0cmVhbVZpZXdUeXBlID8/IGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlLk5FV19BTkRfT0xEX0lNQUdFUylcbiAgICAgIDogdW5kZWZpbmVkO1xuXG4gICAgdGhpcy50YWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlRhYmxlXCIsIHtcbiAgICAgIHRhYmxlTmFtZTogcHJvcHMudGFibGVOYW1lLFxuICAgICAgYmlsbGluZ01vZGUsXG4gICAgICBwYXJ0aXRpb25LZXk6IHtcbiAgICAgICAgbmFtZTogcHJvcHMucGFydGl0aW9uS2V5TmFtZSxcbiAgICAgICAgdHlwZTogcHJvcHMucGFydGl0aW9uS2V5VHlwZSA/PyBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICBzb3J0S2V5OiB7XG4gICAgICAgIG5hbWU6IHByb3BzLnNvcnRLZXlOYW1lLFxuICAgICAgICB0eXBlOiBwcm9wcy5zb3J0S2V5VHlwZSA/PyBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICAuLi4odHRsQXR0cmlidXRlID8geyB0aW1lVG9MaXZlQXR0cmlidXRlOiB0dGxBdHRyaWJ1dGUgfSA6IHt9KSxcbiAgICAgIHJlbW92YWxQb2xpY3ksXG4gICAgICBkZWxldGlvblByb3RlY3Rpb246IHByb3BzLmRlbGV0aW9uUHJvdGVjdGlvbixcbiAgICAgIHBvaW50SW5UaW1lUmVjb3Zlcnk6IGVuYWJsZVBJVFIsXG4gICAgICBlbmNyeXB0aW9uLFxuICAgICAgZW5jcnlwdGlvbktleTogcHJvcHMuZW5jcnlwdGlvbktleSxcbiAgICAgIHN0cmVhbSxcbiAgICAgIC4uLihiaWxsaW5nTW9kZSA9PT0gZHluYW1vZGIuQmlsbGluZ01vZGUuUFJPVklTSU9ORURcbiAgICAgICAgPyB7XG4gICAgICAgICAgcmVhZENhcGFjaXR5OiBwcm9wcy5yZWFkQ2FwYWNpdHkgPz8gNSxcbiAgICAgICAgICB3cml0ZUNhcGFjaXR5OiBwcm9wcy53cml0ZUNhcGFjaXR5ID8/IDUsXG4gICAgICAgIH1cbiAgICAgICAgOiB7fSksXG4gICAgfSk7XG5cbiAgICBmb3IgKGNvbnN0IGdzaSBvZiBwcm9wcy5nbG9iYWxTZWNvbmRhcnlJbmRleGVzID8/IFtdKSB7XG4gICAgICB0aGlzLnRhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgICAgaW5kZXhOYW1lOiBnc2kuaW5kZXhOYW1lLFxuICAgICAgICBwYXJ0aXRpb25LZXk6IHtcbiAgICAgICAgICBuYW1lOiBnc2kucGFydGl0aW9uS2V5TmFtZSxcbiAgICAgICAgICB0eXBlOiBnc2kucGFydGl0aW9uS2V5VHlwZSA/PyBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgICAgfSxcbiAgICAgICAgc29ydEtleTogZ3NpLnNvcnRLZXlOYW1lXG4gICAgICAgICAgPyB7XG4gICAgICAgICAgICBuYW1lOiBnc2kuc29ydEtleU5hbWUsXG4gICAgICAgICAgICB0eXBlOiBnc2kuc29ydEtleVR5cGUgPz8gZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcsXG4gICAgICAgICAgfVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICBwcm9qZWN0aW9uVHlwZTogZ3NpLnByb2plY3Rpb25UeXBlID8/IGR5bmFtb2RiLlByb2plY3Rpb25UeXBlLkFMTCxcbiAgICAgICAgbm9uS2V5QXR0cmlidXRlczogZ3NpLm5vbktleUF0dHJpYnV0ZXMsXG4gICAgICAgIC4uLihiaWxsaW5nTW9kZSA9PT0gZHluYW1vZGIuQmlsbGluZ01vZGUuUFJPVklTSU9ORURcbiAgICAgICAgICA/IHtcbiAgICAgICAgICAgIHJlYWRDYXBhY2l0eTogZ3NpLnJlYWRDYXBhY2l0eSA/PyA1LFxuICAgICAgICAgICAgd3JpdGVDYXBhY2l0eTogZ3NpLndyaXRlQ2FwYWNpdHkgPz8gNSxcbiAgICAgICAgICB9XG4gICAgICAgICAgOiB7fSksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGdyYW50ZWUgb2YgcHJvcHMuZ3JhbnRSZWFkVG8gPz8gW10pIHtcbiAgICAgIHRoaXMudGFibGUuZ3JhbnRSZWFkRGF0YShncmFudGVlKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBncmFudGVlIG9mIHByb3BzLmdyYW50V3JpdGVUbyA/PyBbXSkge1xuICAgICAgdGhpcy50YWJsZS5ncmFudFdyaXRlRGF0YShncmFudGVlKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBncmFudGVlIG9mIHByb3BzLmdyYW50UmVhZFdyaXRlVG8gPz8gW10pIHtcbiAgICAgIHRoaXMudGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKGdyYW50ZWUpO1xuICAgIH1cbiAgICBpZiAoKHByb3BzLmdyYW50U3RyZWFtUmVhZFRvID8/IFtdKS5sZW5ndGggPiAwICYmICFlbmFibGVTdHJlYW0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkFwcFRoZW9yeUR5bmFtb1RhYmxlIHJlcXVpcmVzIGVuYWJsZVN0cmVhbSB3aGVuIHVzaW5nIGdyYW50U3RyZWFtUmVhZFRvXCIpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGdyYW50ZWUgb2YgcHJvcHMuZ3JhbnRTdHJlYW1SZWFkVG8gPz8gW10pIHtcbiAgICAgIHRoaXMudGFibGUuZ3JhbnRTdHJlYW1SZWFkKGdyYW50ZWUpO1xuICAgIH1cbiAgfVxufVxuIl19