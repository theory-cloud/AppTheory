"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppTheoryDynamoTable = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const constructs_1 = require("constructs");
class AppTheoryDynamoTable extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const billingMode = props.billingMode ?? dynamodb.BillingMode.PAY_PER_REQUEST;
        const removalPolicy = props.removalPolicy ?? aws_cdk_lib_1.RemovalPolicy.RETAIN;
        const ttlAttribute = props.timeToLiveAttribute ?? "ttl";
        const enablePITR = props.enablePointInTimeRecovery ?? true;
        const encryption = props.encryption ?? dynamodb.TableEncryption.AWS_MANAGED;
        const enableStream = props.enableStream ?? false;
        if (encryption === dynamodb.TableEncryption.CUSTOMER_MANAGED && !props.encryptionKey) {
            throw new Error("AppTheoryDynamoTable requires encryptionKey when encryption is CUSTOMER_MANAGED");
        }
        const stream = enableStream
            ? (props.streamViewType ?? dynamodb.StreamViewType.NEW_AND_OLD_IMAGES)
            : undefined;
        this.table = new dynamodb.Table(this, "Table", {
            tableName: props.tableName,
            billingMode,
            partitionKey: {
                name: props.partitionKeyName,
                type: props.partitionKeyType ?? dynamodb.AttributeType.STRING,
            },
            sortKey: {
                name: props.sortKeyName,
                type: props.sortKeyType ?? dynamodb.AttributeType.STRING,
            },
            timeToLiveAttribute: ttlAttribute,
            removalPolicy,
            pointInTimeRecovery: enablePITR,
            encryption,
            encryptionKey: props.encryptionKey,
            stream,
            ...(billingMode === dynamodb.BillingMode.PROVISIONED
                ? {
                    readCapacity: props.readCapacity ?? 5,
                    writeCapacity: props.writeCapacity ?? 5,
                }
                : {}),
        });
        for (const gsi of props.globalSecondaryIndexes ?? []) {
            this.table.addGlobalSecondaryIndex({
                indexName: gsi.indexName,
                partitionKey: {
                    name: gsi.partitionKeyName,
                    type: gsi.partitionKeyType ?? dynamodb.AttributeType.STRING,
                },
                sortKey: gsi.sortKeyName
                    ? {
                        name: gsi.sortKeyName,
                        type: gsi.sortKeyType ?? dynamodb.AttributeType.STRING,
                    }
                    : undefined,
                projectionType: gsi.projectionType ?? dynamodb.ProjectionType.ALL,
                nonKeyAttributes: gsi.nonKeyAttributes,
                ...(billingMode === dynamodb.BillingMode.PROVISIONED
                    ? {
                        readCapacity: gsi.readCapacity ?? 5,
                        writeCapacity: gsi.writeCapacity ?? 5,
                    }
                    : {}),
            });
        }
        for (const grantee of props.grantReadTo ?? []) {
            this.table.grantReadData(grantee);
        }
        for (const grantee of props.grantWriteTo ?? []) {
            this.table.grantWriteData(grantee);
        }
        for (const grantee of props.grantReadWriteTo ?? []) {
            this.table.grantReadWriteData(grantee);
        }
        if ((props.grantStreamReadTo ?? []).length > 0 && !enableStream) {
            throw new Error("AppTheoryDynamoTable requires enableStream when using grantStreamReadTo");
        }
        for (const grantee of props.grantStreamReadTo ?? []) {
            this.table.grantStreamRead(grantee);
        }
    }
}
exports.AppTheoryDynamoTable = AppTheoryDynamoTable;
_a = JSII_RTTI_SYMBOL_1;
AppTheoryDynamoTable[_a] = { fqn: "@theory-cloud/apptheory-cdk.AppTheoryDynamoTable", version: "0.2.1" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vLXRhYmxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHluYW1vLXRhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNkNBQTRDO0FBQzVDLHFEQUFxRDtBQUdyRCwyQ0FBdUM7QUFzQ3ZDLE1BQWEsb0JBQXFCLFNBQVEsc0JBQVM7SUFHakQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFnQztRQUN4RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLElBQUksUUFBUSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUM7UUFDOUUsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLGFBQWEsSUFBSSwyQkFBYSxDQUFDLE1BQU0sQ0FBQztRQUNsRSxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsbUJBQW1CLElBQUksS0FBSyxDQUFDO1FBQ3hELE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyx5QkFBeUIsSUFBSSxJQUFJLENBQUM7UUFDM0QsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLFVBQVUsSUFBSSxRQUFRLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQztRQUM1RSxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsWUFBWSxJQUFJLEtBQUssQ0FBQztRQUVqRCxJQUFJLFVBQVUsS0FBSyxRQUFRLENBQUMsZUFBZSxDQUFDLGdCQUFnQixJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3JGLE1BQU0sSUFBSSxLQUFLLENBQUMsaUZBQWlGLENBQUMsQ0FBQztRQUNyRyxDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQUcsWUFBWTtZQUN6QixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxJQUFJLFFBQVEsQ0FBQyxjQUFjLENBQUMsa0JBQWtCLENBQUM7WUFDdEUsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUVkLElBQUksQ0FBQyxLQUFL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LENBQUMsWUFBWSxFQUFFLENBQUM7WUFDaEUsTUFBTSxJQUFJLEtBQUssQ0FBQyx5RUFBeUUsQ0FBQyxDQUFDO1FBQzdGLENBQUM7UUFDRCxLQUFLLE1BQU0sT0FBTyxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUNwRCxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0QyxDQUFDO0lBQ0gsQ0FBQzs7QUFyRkgsb0RBc0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVtb3ZhbFBvbGljeSB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1keW5hbW9kYlwiO1xuaW1wb3J0IHR5cGUgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCB0eXBlICogYXMga21zIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mta21zXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFwcFRoZW9yeUR5bmFtb1RhYmxlR3NpUHJvcHMge1xuICByZWFkb25seSBpbmRleE5hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgcGFydGl0aW9uS2V5TmFtZTogc3RyaW5nO1xuICByZWFkb25seSBwYXJ0aXRpb25LZXlUeXBlPzogZHluYW1vZGIuQXR0cmlidXRlVHlwZTtcbiAgcmVhZG9ubHkgc29ydEtleU5hbWU/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHNvcnRLZXlUeXBlPzogZHluYW1vZGIuQXR0cmlidXRlVHlwZTtcbiAgcmVhZG9ubHkgcHJvamVjdGlvblR5cGU/OiBkeW5hbW9kYi5Qcm9qZWN0aW9uVHlwZTtcbiAgcmVhZG9ubHkgbm9uS2V5QXR0cmlidXRlcz86IHN0cmluZ1tdO1xuICByZWFkb25seSByZWFkQ2FwYWNpdHk/OiBudW1iZXI7XG4gIHJlYWRvbmx5IHdyaXRlQ2FwYWNpdHk/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwVGhlb3J5RHluYW1vVGFibGVQcm9wcyB7XG4gIHJlYWRvbmx5IHRhYmxlTmFtZTogc3RyaW5nO1xuICByZWFkb25seSBwYXJ0aXRpb25LZXlOYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHBhcnRpdGlvbktleVR5cGU/OiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlO1xuICByZWFkb25seSBzb3J0S2V5TmFtZTogc3RyaW5nO1xuICByZWFkb25seSBzb3J0S2V5VHlwZT86IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGU7XG4gIHJlYWRvbmx5IHRpbWVUb0xpdmVBdHRyaWJ1dGU/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGJpbGxpbmdNb2RlPzogZHluYW1vZGIuQmlsbGluZ01vZGU7XG4gIHJlYWRvbmx5IHJlYWRDYXBhY2l0eT86IG51bWJlcjtcbiAgcmVhZG9ubHkgd3JpdGVDYXBhY2l0eT86IG51bWJlcjtcbiAgcmVhZG9ubHkgcmVtb3ZhbFBvbGljeT86IFJlbW92YWxQb2xpY3k7XG4gIHJlYWRvbmx5IGVuYWJsZVBvaW50SW5UaW1lUmVjb3Zlcnk/OiBib29sZWFuO1xuICByZWFkb25seSBlbmNyeXB0aW9uPzogZHluYW1vZGIuVGFibGVFbmNyeXB0aW9uO1xuICByZWFkb25seSBlbmNyeXB0aW9uS2V5Pzoga21zLklLZXk7XG4gIHJlYWRvbmx5IGVuYWJsZVN0cmVhbT86IGJvb2xlYW47XG4gIHJlYWRvbmx5IHN0cmVhbVZpZXdUeXBlPzogZHluYW1vZGIuU3RyZWFtVmlld1R5cGU7XG4gIHJlYWRvbmx5IGdsb2JhbFNlY29uZGFyeUluZGV4ZXM/OiBBcHBUaGVvcnlEeW5hbW9UYWJsZUdzaVByb3BzW107XG5cbiAgcmVhZG9ubHkgZ3JhbnRSZWFkVG8/OiBpYW0uSUdyYW50YWJsZVtdO1xuICByZWFkb25seSBncmFudFdyaXRlVG8/OiBpYW0uSUdyYW50YWJsZVtdO1xuICByZWFkb25seSBncmFudFJlYWRXcml0ZVRvPzogaWFtLklHcmFudGFibGVbXTtcbiAgcmVhZG9ubHkgZ3JhbnRTdHJlYW1SZWFkVG8/OiBpYW0uSUdyYW50YWJsZVtdO1xufVxuXG5leHBvcnQgY2xhc3MgQXBwVGhlb3J5RHluYW1vVGFibGUgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgdGFibGU6IGR5bmFtb2RiLlRhYmxlO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBBcHBUaGVvcnlEeW5hbW9UYWJsZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IGJpbGxpbmdNb2RlID0gcHJvcHMuYmlsbGluZ01vZGUgPz8gZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNUO1xuICAgIGNvbnN0IHJlbW92YWxQb2xpY3kgPSBwcm9wcy5yZW1vdmFsUG9saWN5ID8/IFJlbW92YWxQb2xpY3kuUkVUQUlOO1xuICAgIGNvbnN0IHR0bEF0dHJpYnV0ZSA9IHByb3BzLnRpbWVUb0xpdmVBdHRyaWJ1dGUgPz8gXCJ0dGxcIjtcbiAgICBjb25zdCBlbmFibGVQSVRSID0gcHJvcHMuZW5hYmxlUG9pbnRJblRpbWVSZWNvdmVyeSA/PyB0cnVlO1xuICAgIGNvbnN0IGVuY3J5cHRpb24gPSBwcm9wcy5lbmNyeXB0aW9uID8/IGR5bmFtb2RiLlRhYmxlRW5jcnlwdGlvbi5BV1NfTUFOQUdFRDtcbiAgICBjb25zdCBlbmFibGVTdHJlYW0gPSBwcm9wcy5lbmFibGVTdHJlYW0gPz8gZmFsc2U7XG5cbiAgICBpZiAoZW5jcnlwdGlvbiA9PT0gZHluYW1vZGIuVGFibGVFbmNyeXB0aW9uLkNVU1RPTUVSX01BTkFHRUQgJiYgIXByb3BzLmVuY3J5cHRpb25LZXkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkFwcFRoZW9yeUR5bmFtb1RhYmxlIHJlcXVpcmVzIGVuY3J5cHRpb25LZXkgd2hlbiBlbmNyeXB0aW9uIGlzIENVU1RPTUVSX01BTkFHRURcIik7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RyZWFtID0gZW5hYmxlU3RyZWFtXG4gICAgICA/IChwcm9wcy5zdHJlYW1WaWV3VHlwZSA/PyBkeW5hbW9kYi5TdHJlYW1WaWV3VHlwZS5ORVdfQU5EX09MRF9JTUFHRVMpXG4gICAgICA6IHVuZGVmaW5lZDtcblxuICAgIHRoaXMudGFibGUgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgXCJUYWJsZVwiLCB7XG4gICAgICB0YWJsZU5hbWU6IHByb3BzLnRhYmxlTmFtZSxcbiAgICAgIGJpbGxpbmdNb2RlLFxuICAgICAgcGFydGl0aW9uS2V5OiB7XG4gICAgICAgIG5hbWU6IHByb3BzLnBhcnRpdGlvbktleU5hbWUsXG4gICAgICAgIHR5cGU6IHByb3BzLnBhcnRpdGlvbktleVR5cGUgPz8gZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcsXG4gICAgICB9LFxuICAgICAgc29ydEtleToge1xuICAgICAgICBuYW1lOiBwcm9wcy5zb3J0S2V5TmFtZSxcbiAgICAgICAgdHlwZTogcHJvcHMuc29ydEtleVR5cGUgPz8gZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcsXG4gICAgICB9LFxuICAgICAgdGltZVRvTGl2ZUF0dHJpYnV0ZTogdHRsQXR0cmlidXRlLFxuICAgICAgcmVtb3ZhbFBvbGljeSxcbiAgICAgIHBvaW50SW5UaW1lUmVjb3Zlcnk6IGVuYWJsZVBJVFIsXG4gICAgICBlbmNyeXB0aW9uLFxuICAgICAgZW5jcnlwdGlvbktleTogcHJvcHMuZW5jcnlwdGlvbktleSxcbiAgICAgIHN0cmVhbSxcbiAgICAgIC4uLihiaWxsaW5nTW9kZSA9PT0gZHluYW1vZGIuQmlsbGluZ01vZGUuUFJPVklTSU9ORURcbiAgICAgICAgPyB7XG4gICAgICAgICAgICByZWFkQ2FwYWNpdHk6IHByb3BzLnJlYWRDYXBhY2l0eSA/PyA1LFxuICAgICAgICAgICAgd3JpdGVDYXBhY2l0eTogcHJvcHMud3JpdGVDYXBhY2l0eSA/PyA1LFxuICAgICAgICAgIH1cbiAgICAgICAgOiB7fSksXG4gICAgfSk7XG5cbiAgICBmb3IgKGNvbnN0IGdzaSBvZiBwcm9wcy5nbG9iYWxTZWNvbmRhcnlJbmRleGVzID8/IFtdKSB7XG4gICAgICB0aGlzLnRhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgICAgaW5kZXhOYW1lOiBnc2kuaW5kZXhOYW1lLFxuICAgICAgICBwYXJ0aXRpb25LZXk6IHtcbiAgICAgICAgICBuYW1lOiBnc2kucGFydGl0aW9uS2V5TmFtZSxcbiAgICAgICAgICB0eXBlOiBnc2kucGFydGl0aW9uS2V5VHlwZSA/PyBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgICAgfSxcbiAgICAgICAgc29ydEtleTogZ3NpLnNvcnRLZXlOYW1lXG4gICAgICAgICAgPyB7XG4gICAgICAgICAgICAgIG5hbWU6IGdzaS5zb3J0S2V5TmFtZSxcbiAgICAgICAgICAgICAgdHlwZTogZ3NpLnNvcnRLZXlUeXBlID8/IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HLFxuICAgICAgICAgICAgfVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICBwcm9qZWN0aW9uVHlwZTogZ3NpLnByb2plY3Rpb25UeXBlID8/IGR5bmFtb2RiLlByb2plY3Rpb25UeXBlLkFMTCxcbiAgICAgICAgbm9uS2V5QXR0cmlidXRlczogZ3NpLm5vbktleUF0dHJpYnV0ZXMsXG4gICAgICAgIC4uLihiaWxsaW5nTW9kZSA9PT0gZHluYW1vZGIuQmlsbGluZ01vZGUuUFJPVklTSU9ORURcbiAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgcmVhZENhcGFjaXR5OiBnc2kucmVhZENhcGFjaXR5ID8/IDUsXG4gICAgICAgICAgICAgIHdyaXRlQ2FwYWNpdHk6IGdzaS53cml0ZUNhcGFjaXR5ID8/IDUsXG4gICAgICAgICAgICB9XG4gICAgICAgICAgOiB7fSksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGdyYW50ZWUgb2YgcHJvcHMuZ3JhbnRSZWFkVG8gPz8gW10pIHtcbiAgICAgIHRoaXMudGFibGUuZ3JhbnRSZWFkRGF0YShncmFudGVlKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBncmFudGVlIG9mIHByb3BzLmdyYW50V3JpdGVUbyA/PyBbXSkge1xuICAgICAgdGhpcy50YWJsZS5ncmFudFdyaXRlRGF0YShncmFudGVlKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBncmFudGVlIG9mIHByb3BzLmdyYW50UmVhZFdyaXRlVG8gPz8gW10pIHtcbiAgICAgIHRoaXMudGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKGdyYW50ZWUpO1xuICAgIH1cbiAgICBpZiAoKHByb3BzLmdyYW50U3RyZWFtUmVhZFRvID8/IFtdKS5sZW5ndGggPiAwICYmICFlbmFibGVTdHJlYW0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkFwcFRoZW9yeUR5bmFtb1RhYmxlIHJlcXVpcmVzIGVuYWJsZVN0cmVhbSB3aGVuIHVzaW5nIGdyYW50U3RyZWFtUmVhZFRvXCIpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGdyYW50ZWUgb2YgcHJvcHMuZ3JhbnRTdHJlYW1SZWFkVG8gPz8gW10pIHtcbiAgICAgIHRoaXMudGFibGUuZ3JhbnRTdHJlYW1SZWFkKGdyYW50ZWUpO1xuICAgIH1cbiAgfVxufVxuXG4iXX0=