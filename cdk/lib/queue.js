"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppTheoryQueue = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const sqs = require("aws-cdk-lib/aws-sqs");
const constructs_1 = require("constructs");
/**
 * A composable SQS queue construct with optional DLQ support.
 *
 * This construct creates an SQS queue with optional Dead Letter Queue (DLQ) configuration.
 * It can be used standalone (for manual message production/consumption) or composed
 * with AppTheoryQueueConsumer for Lambda integration.
 *
 * @example
 * // Queue with DLQ (default)
 * const queue = new AppTheoryQueue(stack, 'Queue', {
 *   queueName: 'my-queue',
 * });
 *
 * @example
 * // Queue without DLQ
 * const queue = new AppTheoryQueue(stack, 'Queue', {
 *   queueName: 'my-queue',
 *   enableDlq: false,
 * });
 *
 * @example
 * // Queue with custom DLQ configuration
 * const queue = new AppTheoryQueue(stack, 'Queue', {
 *   queueName: 'my-queue',
 *   maxReceiveCount: 5,
 *   dlqRetentionPeriod: Duration.days(14),
 * });
 */
class AppTheoryQueue extends constructs_1.Construct {
    constructor(scope, id, props = {}) {
        super(scope, id);
        const enableDlq = props.enableDlq !== false;
        const removalPolicy = props.removalPolicy ?? aws_cdk_lib_1.RemovalPolicy.DESTROY;
        // Create DLQ if enabled
        if (enableDlq) {
            const dlqName = props.queueName ? `${props.queueName}-dlq` : undefined;
            this.deadLetterQueue = new sqs.Queue(this, "DeadLetterQueue", {
                queueName: props.fifo && dlqName ? `${dlqName}.fifo` : dlqName,
                visibilityTimeout: props.dlqVisibilityTimeout ?? props.visibilityTimeout,
                retentionPeriod: props.dlqRetentionPeriod ?? aws_cdk_lib_1.Duration.days(14),
                encryption: props.encryption,
                fifo: props.fifo,
                contentBasedDeduplication: props.fifo ? props.contentBasedDeduplication : undefined,
                removalPolicy,
            });
        }
        // Create main queue
        this.queue = new sqs.Queue(this, "Queue", {
            queueName: props.fifo && props.queueName ? `${props.queueName}.fifo` : props.queueName,
            visibilityTimeout: props.visibilityTimeout,
            retentionPeriod: props.retentionPeriod,
            receiveMessageWaitTime: props.receiveMessageWaitTime,
            encryption: props.encryption,
            fifo: props.fifo,
            contentBasedDeduplication: props.fifo ? props.contentBasedDeduplication : undefined,
            deadLetterQueue: this.deadLetterQueue
                ? {
                    queue: this.deadLetterQueue,
                    maxReceiveCount: props.maxReceiveCount ?? 3,
                }
                : undefined,
            removalPolicy,
        });
        // Expose convenience properties
        this.queueArn = this.queue.queueArn;
        this.queueUrl = this.queue.queueUrl;
        this.queueName = this.queue.queueName;
        // Grant send permissions if specified
        if (props.grantSendMessagesTo) {
            for (const fn of props.grantSendMessagesTo) {
                this.queue.grantSendMessages(fn);
            }
        }
    }
    /**
     * Grant send messages permission to a Lambda function.
     */
    grantSendMessages(grantee) {
        this.queue.grantSendMessages(grantee);
    }
    /**
     * Grant consume messages permission to a Lambda function.
     */
    grantConsumeMessages(grantee) {
        this.queue.grantConsumeMessages(grantee);
    }
    /**
     * Grant purge messages permission to a Lambda function.
     */
    grantPurge(grantee) {
        this.queue.grantPurge(grantee);
    }
}
exports.AppTheoryQueue = AppTheoryQueue;
_a = JSII_RTTI_SYMBOL_1;
AppTheoryQueue[_a] = { fqn: "@theory-cloud/apptheory-cdk.AppTheoryQueue", version: "0.8.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVldWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJxdWV1ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLDZDQUFzRDtBQUV0RCwyQ0FBMkM7QUFDM0MsMkNBQXVDO0FBd0Z2Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBMkJHO0FBQ0gsTUFBYSxjQUFlLFNBQVEsc0JBQVM7SUEwQnpDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBNkIsRUFBRTtRQUNyRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLEtBQUssS0FBSyxDQUFDO1FBQzVDLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxhQUFhLElBQUksMkJBQWEsQ0FBQyxPQUFPLENBQUM7UUFFbkUsd0JBQXdCO1FBQ3hCLElBQUksU0FBUyxFQUFFLENBQUM7WUFDWixNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxTQUFTLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQ3ZFLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRTtnQkFDMUQsU0FBUyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPO2dCQUM5RCxpQkFBaUIsRUFBRSxLQUFLLENBQUMsb0JBQW9CLElBQUksS0FBSyxDQUFDLGlCQUFpQjtnQkFDeEUsZUFBZSxFQUFFLEtBQUssQ0FBQyxrQkFBa0IsSUFBSSxzQkFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQzlELFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVTtnQkFDNUIsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO2dCQUNoQix5QkFBeUIsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDLFNBQVM7Z0JBQ25GLGFBQWE7YUFDaEIsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztRQUVELG9CQUFvQjtRQUNwQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO1lBQ3RDLFNBQVMsRUFBRSxLQUFLLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLFNBQVMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUztZQUN0RixpQkFBaUIsRUFBRSxLQUFLLENBQUMsaUJBQWlCO1lBQzFDLGVBQWUsRUFBRSxLQUFLLENBQUMsZUFBZTtZQUN0QyxzQkFBc0IsRUFBRSxLQUFLLENBQUMsc0JBQXNCO1lBQ3BELFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVTtZQUM1QixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7WUFDaEIseUJBQXlCLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQ25GLGVBQWUsRUFBRSxJQUFJLENBQUMsZUFBZTtnQkFDakMsQ0FBQyxDQUFDO29CQUNFLEtBQUssRUFBRSxJQUFJLENBQUMsZUFBZTtvQkFDM0IsZUFBZSxFQUFFLEtBQUssQ0FBQyxlQUFlLElBQUksQ0FBQztpQkFDOUM7Z0JBQ0QsQ0FBQyxDQUFDLFNBQVM7WUFDZixhQUFhO1NBQ2hCLENBQUMsQ0FBQztRQUVILGdDQUFnQztRQUNoQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7UUFDcEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUV0QyxzQ0FBc0M7UUFDdEMsSUFBSSxLQUFLLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUM1QixLQUFLLE1BQU0sRUFBRSxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO2dCQUN6QyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3JDLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ksaUJBQWlCLENBQUMsT0FBeUI7UUFDOUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQ7O09BRUc7SUFDSSxvQkFBb0IsQ0FBQyxPQUF5QjtRQUNqRCxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRDs7T0FFRztJQUNJLFVBQVUsQ0FBQyxPQUF5QjtRQUN2QyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQyxDQUFDOztBQWhHTCx3Q0FpR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEdXJhdGlvbiwgUmVtb3ZhbFBvbGljeSB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHR5cGUgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIHNxcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNxc1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcblxuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciBBcHBUaGVvcnlRdWV1ZSBjb25zdHJ1Y3QuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXBwVGhlb3J5UXVldWVQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgb2YgdGhlIHF1ZXVlLlxuICAgICAqIEBkZWZhdWx0IC0gQ2xvdWRGb3JtYXRpb24tZ2VuZXJhdGVkIG5hbWVcbiAgICAgKi9cbiAgICByZWFkb25seSBxdWV1ZU5hbWU/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgdmlzaWJpbGl0eSB0aW1lb3V0IGZvciBtZXNzYWdlcyBpbiB0aGUgcXVldWUuXG4gICAgICogQGRlZmF1bHQgRHVyYXRpb24uc2Vjb25kcygzMClcbiAgICAgKi9cbiAgICByZWFkb25seSB2aXNpYmlsaXR5VGltZW91dD86IER1cmF0aW9uO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG51bWJlciBvZiBzZWNvbmRzIHRoYXQgQW1hem9uIFNRUyByZXRhaW5zIGEgbWVzc2FnZS5cbiAgICAgKiBAZGVmYXVsdCBEdXJhdGlvbi5kYXlzKDQpXG4gICAgICovXG4gICAgcmVhZG9ubHkgcmV0ZW50aW9uUGVyaW9kPzogRHVyYXRpb247XG5cbiAgICAvKipcbiAgICAgKiBUaGUgYW1vdW50IG9mIHRpbWUgZm9yIHdoaWNoIGEgUmVjZWl2ZU1lc3NhZ2UgY2FsbCB3aWxsIHdhaXQgZm9yIGEgbWVzc2FnZSB0byBhcnJpdmUgaW4gdGhlIHF1ZXVlXG4gICAgICogYmVmb3JlIHJldHVybmluZy4gVXNlZCBmb3IgU1FTIGxvbmcgcG9sbGluZy5cbiAgICAgKiBAZGVmYXVsdCB1bmRlZmluZWRcbiAgICAgKi9cbiAgICByZWFkb25seSByZWNlaXZlTWVzc2FnZVdhaXRUaW1lPzogRHVyYXRpb247XG5cbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIHRvIGVuYWJsZSBhIERlYWQgTGV0dGVyIFF1ZXVlIChETFEpLlxuICAgICAqIEBkZWZhdWx0IHRydWVcbiAgICAgKi9cbiAgICByZWFkb25seSBlbmFibGVEbHE/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIHRpbWVzIGEgbWVzc2FnZSBjYW4gYmUgcmVjZWl2ZWQgYmVmb3JlIGJlaW5nIHNlbnQgdG8gdGhlIERMUS5cbiAgICAgKiBPbmx5IGFwcGxpY2FibGUgd2hlbiBlbmFibGVEbHEgaXMgdHJ1ZS5cbiAgICAgKiBAZGVmYXVsdCAzXG4gICAgICovXG4gICAgcmVhZG9ubHkgbWF4UmVjZWl2ZUNvdW50PzogbnVtYmVyO1xuXG4gICAgLyoqXG4gICAgICogVGhlIHZpc2liaWxpdHkgdGltZW91dCBmb3IgdGhlIERMUS5cbiAgICAgKiBAZGVmYXVsdCAtIFNhbWUgYXMgdGhlIG1haW4gcXVldWVcbiAgICAgKi9cbiAgICByZWFkb25seSBkbHFWaXNpYmlsaXR5VGltZW91dD86IER1cmF0aW9uO1xuXG4gICAgLyoqXG4gICAgICogVGhlIHJldGVudGlvbiBwZXJpb2QgZm9yIHRoZSBETFEuXG4gICAgICogQGRlZmF1bHQgRHVyYXRpb24uZGF5cygxNClcbiAgICAgKi9cbiAgICByZWFkb25seSBkbHFSZXRlbnRpb25QZXJpb2Q/OiBEdXJhdGlvbjtcblxuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgbWVzc2FnZXMgZGVsaXZlcmVkIHRvIHRoZSBxdWV1ZSB3aWxsIGJlIGVuY3J5cHRlZC5cbiAgICAgKiBAZGVmYXVsdCAtIEFXUyBtYW5hZ2VkIGVuY3J5cHRpb24gaXMgdXNlZFxuICAgICAqL1xuICAgIHJlYWRvbmx5IGVuY3J5cHRpb24/OiBzcXMuUXVldWVFbmNyeXB0aW9uO1xuXG4gICAgLyoqXG4gICAgICogV2hldGhlciB0byBlbmFibGUgY29udGVudC1iYXNlZCBkZWR1cGxpY2F0aW9uIGZvciBGSUZPIHF1ZXVlcy5cbiAgICAgKiBPbmx5IGFwcGxpY2FibGUgZm9yIEZJRk8gcXVldWVzLlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgcmVhZG9ubHkgY29udGVudEJhc2VkRGVkdXBsaWNhdGlvbj86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIHRoZSBxdWV1ZSBpcyBhIEZJRk8gcXVldWUuXG4gICAgICogQGRlZmF1bHQgZmFsc2VcbiAgICAgKi9cbiAgICByZWFkb25seSBmaWZvPzogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIFByaW5jaXBhbHMgdG8gZ3JhbnQgc2VuZCBtZXNzYWdlcyBwZXJtaXNzaW9uIHRvLlxuICAgICAqIEBkZWZhdWx0IC0gTm8gYWRkaXRpb25hbCBwcmluY2lwYWxzXG4gICAgICovXG4gICAgcmVhZG9ubHkgZ3JhbnRTZW5kTWVzc2FnZXNUbz86IGxhbWJkYS5JRnVuY3Rpb25bXTtcblxuICAgIC8qKlxuICAgICAqIFRoZSByZW1vdmFsIHBvbGljeSBmb3IgdGhlIHF1ZXVlKHMpLlxuICAgICAqIEBkZWZhdWx0IFJlbW92YWxQb2xpY3kuREVTVFJPWVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHJlbW92YWxQb2xpY3k/OiBSZW1vdmFsUG9saWN5O1xufVxuXG4vKipcbiAqIEEgY29tcG9zYWJsZSBTUVMgcXVldWUgY29uc3RydWN0IHdpdGggb3B0aW9uYWwgRExRIHN1cHBvcnQuXG4gKlxuICogVGhpcyBjb25zdHJ1Y3QgY3JlYXRlcyBhbiBTUVMgcXVldWUgd2l0aCBvcHRpb25hbCBEZWFkIExldHRlciBRdWV1ZSAoRExRKSBjb25maWd1cmF0aW9uLlxuICogSXQgY2FuIGJlIHVzZWQgc3RhbmRhbG9uZSAoZm9yIG1hbnVhbCBtZXNzYWdlIHByb2R1Y3Rpb24vY29uc3VtcHRpb24pIG9yIGNvbXBvc2VkXG4gKiB3aXRoIEFwcFRoZW9yeVF1ZXVlQ29uc3VtZXIgZm9yIExhbWJkYSBpbnRlZ3JhdGlvbi5cbiAqXG4gKiBAZXhhbXBsZVxuICogLy8gUXVldWUgd2l0aCBETFEgKGRlZmF1bHQpXG4gKiBjb25zdCBxdWV1ZSA9IG5ldyBBcHBUaGVvcnlRdWV1ZShzdGFjaywgJ1F1ZXVlJywge1xuICogICBxdWV1ZU5hbWU6ICdteS1xdWV1ZScsXG4gKiB9KTtcbiAqXG4gKiBAZXhhbXBsZVxuICogLy8gUXVldWUgd2l0aG91dCBETFFcbiAqIGNvbnN0IHF1ZXVlID0gbmV3IEFwcFRoZW9yeVF1ZXVlKHN0YWNrLCAnUXVldWUnLCB7XG4gKiAgIHF1ZXVlTmFtZTogJ215LXF1ZXVlJyxcbiAqICAgZW5hYmxlRGxxOiBmYWxzZSxcbiAqIH0pO1xuICpcbiAqIEBleGFtcGxlXG4gKiAvLyBRdWV1ZSB3aXRoIGN1c3RvbSBETFEgY29uZmlndXJhdGlvblxuICogY29uc3QgcXVldWUgPSBuZXcgQXBwVGhlb3J5UXVldWUoc3RhY2ssICdRdWV1ZScsIHtcbiAqICAgcXVldWVOYW1lOiAnbXktcXVldWUnLFxuICogICBtYXhSZWNlaXZlQ291bnQ6IDUsXG4gKiAgIGRscVJldGVudGlvblBlcmlvZDogRHVyYXRpb24uZGF5cygxNCksXG4gKiB9KTtcbiAqL1xuZXhwb3J0IGNsYXNzIEFwcFRoZW9yeVF1ZXVlIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgICAvKipcbiAgICAgKiBUaGUgbWFpbiBTUVMgcXVldWUuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IHF1ZXVlOiBzcXMuUXVldWU7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgRGVhZCBMZXR0ZXIgUXVldWUsIGlmIGVuYWJsZWQuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGRlYWRMZXR0ZXJRdWV1ZT86IHNxcy5RdWV1ZTtcblxuICAgIC8qKlxuICAgICAqIFRoZSBBUk4gb2YgdGhlIG1haW4gcXVldWUuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IHF1ZXVlQXJuOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgVVJMIG9mIHRoZSBtYWluIHF1ZXVlLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBxdWV1ZVVybDogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgb2YgdGhlIG1haW4gcXVldWUuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IHF1ZXVlTmFtZTogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEFwcFRoZW9yeVF1ZXVlUHJvcHMgPSB7fSkge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgICAgIGNvbnN0IGVuYWJsZURscSA9IHByb3BzLmVuYWJsZURscSAhPT0gZmFsc2U7XG4gICAgICAgIGNvbnN0IHJlbW92YWxQb2xpY3kgPSBwcm9wcy5yZW1vdmFsUG9saWN5ID8/IFJlbW92YWxQb2xpY3kuREVTVFJPWTtcblxuICAgICAgICAvLyBDcmVhdGUgRExRIGlmIGVuYWJsZWRcbiAgICAgICAgaWYgKGVuYWJsZURscSkge1xuICAgICAgICAgICAgY29uc3QgZGxxTmFtZSA9IHByb3BzLnF1ZXVlTmFtZSA/IGAke3Byb3BzLnF1ZXVlTmFtZX0tZGxxYCA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHRoaXMuZGVhZExldHRlclF1ZXVlID0gbmV3IHNxcy5RdWV1ZSh0aGlzLCBcIkRlYWRMZXR0ZXJRdWV1ZVwiLCB7XG4gICAgICAgICAgICAgICAgcXVldWVOYW1lOiBwcm9wcy5maWZvICYmIGRscU5hbWUgPyBgJHtkbHFOYW1lfS5maWZvYCA6IGRscU5hbWUsXG4gICAgICAgICAgICAgICAgdmlzaWJpbGl0eVRpbWVvdXQ6IHByb3BzLmRscVZpc2liaWxpdHlUaW1lb3V0ID8/IHByb3BzLnZpc2liaWxpdHlUaW1lb3V0LFxuICAgICAgICAgICAgICAgIHJldGVudGlvblBlcmlvZDogcHJvcHMuZGxxUmV0ZW50aW9uUGVyaW9kID8/IER1cmF0aW9uLmRheXMoMTQpLFxuICAgICAgICAgICAgICAgIGVuY3J5cHRpb246IHByb3BzLmVuY3J5cHRpb24sXG4gICAgICAgICAgICAgICAgZmlmbzogcHJvcHMuZmlmbyxcbiAgICAgICAgICAgICAgICBjb250ZW50QmFzZWREZWR1cGxpY2F0aW9uOiBwcm9wcy5maWZvID8gcHJvcHMuY29udGVudEJhc2VkRGVkdXBsaWNhdGlvbiA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICByZW1vdmFsUG9saWN5LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDcmVhdGUgbWFpbiBxdWV1ZVxuICAgICAgICB0aGlzLnF1ZXVlID0gbmV3IHNxcy5RdWV1ZSh0aGlzLCBcIlF1ZXVlXCIsIHtcbiAgICAgICAgICAgIHF1ZXVlTmFtZTogcHJvcHMuZmlmbyAmJiBwcm9wcy5xdWV1ZU5hbWUgPyBgJHtwcm9wcy5xdWV1ZU5hbWV9LmZpZm9gIDogcHJvcHMucXVldWVOYW1lLFxuICAgICAgICAgICAgdmlzaWJpbGl0eVRpbWVvdXQ6IHByb3BzLnZpc2liaWxpdHlUaW1lb3V0LFxuICAgICAgICAgICAgcmV0ZW50aW9uUGVyaW9kOiBwcm9wcy5yZXRlbnRpb25QZXJpb2QsXG4gICAgICAgICAgICByZWNlaXZlTWVzc2FnZVdhaXRUaW1lOiBwcm9wcy5yZWNlaXZlTWVzc2FnZVdhaXRUaW1lLFxuICAgICAgICAgICAgZW5jcnlwdGlvbjogcHJvcHMuZW5jcnlwdGlvbixcbiAgICAgICAgICAgIGZpZm86IHByb3BzLmZpZm8sXG4gICAgICAgICAgICBjb250ZW50QmFzZWREZWR1cGxpY2F0aW9uOiBwcm9wcy5maWZvID8gcHJvcHMuY29udGVudEJhc2VkRGVkdXBsaWNhdGlvbiA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGRlYWRMZXR0ZXJRdWV1ZTogdGhpcy5kZWFkTGV0dGVyUXVldWVcbiAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgcXVldWU6IHRoaXMuZGVhZExldHRlclF1ZXVlLFxuICAgICAgICAgICAgICAgICAgICBtYXhSZWNlaXZlQ291bnQ6IHByb3BzLm1heFJlY2VpdmVDb3VudCA/PyAzLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHJlbW92YWxQb2xpY3ksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEV4cG9zZSBjb252ZW5pZW5jZSBwcm9wZXJ0aWVzXG4gICAgICAgIHRoaXMucXVldWVBcm4gPSB0aGlzLnF1ZXVlLnF1ZXVlQXJuO1xuICAgICAgICB0aGlzLnF1ZXVlVXJsID0gdGhpcy5xdWV1ZS5xdWV1ZVVybDtcbiAgICAgICAgdGhpcy5xdWV1ZU5hbWUgPSB0aGlzLnF1ZXVlLnF1ZXVlTmFtZTtcblxuICAgICAgICAvLyBHcmFudCBzZW5kIHBlcm1pc3Npb25zIGlmIHNwZWNpZmllZFxuICAgICAgICBpZiAocHJvcHMuZ3JhbnRTZW5kTWVzc2FnZXNUbykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBmbiBvZiBwcm9wcy5ncmFudFNlbmRNZXNzYWdlc1RvKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5xdWV1ZS5ncmFudFNlbmRNZXNzYWdlcyhmbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHcmFudCBzZW5kIG1lc3NhZ2VzIHBlcm1pc3Npb24gdG8gYSBMYW1iZGEgZnVuY3Rpb24uXG4gICAgICovXG4gICAgcHVibGljIGdyYW50U2VuZE1lc3NhZ2VzKGdyYW50ZWU6IGxhbWJkYS5JRnVuY3Rpb24pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5xdWV1ZS5ncmFudFNlbmRNZXNzYWdlcyhncmFudGVlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHcmFudCBjb25zdW1lIG1lc3NhZ2VzIHBlcm1pc3Npb24gdG8gYSBMYW1iZGEgZnVuY3Rpb24uXG4gICAgICovXG4gICAgcHVibGljIGdyYW50Q29uc3VtZU1lc3NhZ2VzKGdyYW50ZWU6IGxhbWJkYS5JRnVuY3Rpb24pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5xdWV1ZS5ncmFudENvbnN1bWVNZXNzYWdlcyhncmFudGVlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHcmFudCBwdXJnZSBtZXNzYWdlcyBwZXJtaXNzaW9uIHRvIGEgTGFtYmRhIGZ1bmN0aW9uLlxuICAgICAqL1xuICAgIHB1YmxpYyBncmFudFB1cmdlKGdyYW50ZWU6IGxhbWJkYS5JRnVuY3Rpb24pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5xdWV1ZS5ncmFudFB1cmdlKGdyYW50ZWUpO1xuICAgIH1cbn1cbiJdfQ==