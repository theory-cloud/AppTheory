"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppTheoryApp = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const acm = require("aws-cdk-lib/aws-certificatemanager");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const lambda = require("aws-cdk-lib/aws-lambda");
const constructs_1 = require("constructs");
const api_domain_1 = require("./api-domain");
const function_1 = require("./function");
const http_api_1 = require("./http-api");
class AppTheoryApp extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const appName = String(props.appName ?? "").trim();
        if (!appName) {
            throw new Error("AppTheoryApp requires props.appName");
        }
        const code = props.code ?? (props.codeAssetPath ? lambda.Code.fromAsset(props.codeAssetPath) : undefined);
        if (!code) {
            throw new Error("AppTheoryApp requires either props.code or props.codeAssetPath");
        }
        const env = { ...(props.environment ?? {}) };
        if (props.databaseTable) {
            this.databaseTable = props.databaseTable;
            env.DYNAMODB_TABLE = this.databaseTable.tableName;
        }
        else if (props.enableDatabase) {
            const tableName = props.databaseTableName ?? `${appName}-table`;
            const partitionKeyName = props.databasePartitionKey ?? "ID";
            this.databaseTable = new dynamodb.Table(this, "Database", {
                tableName,
                billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
                partitionKey: { name: partitionKeyName, type: dynamodb.AttributeType.STRING },
                sortKey: props.databaseSortKey
                    ? { name: props.databaseSortKey, type: dynamodb.AttributeType.STRING }
                    : undefined,
                timeToLiveAttribute: "ttl",
                pointInTimeRecovery: true,
                encryption: dynamodb.TableEncryption.AWS_MANAGED,
                stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
            });
            env.DYNAMODB_TABLE = this.databaseTable.tableName;
        }
        if (props.enableRateLimiting) {
            const tableName = props.rateLimitTableName ?? `${appName}-rate-limits`;
            this.rateLimitTable = new dynamodb.Table(this, "RateLimitTable", {
                tableName,
                billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
                partitionKey: { name: "pk", type: dynamodb.AttributeType.STRING },
                sortKey: { name: "sk", type: dynamodb.AttributeType.STRING },
                timeToLiveAttribute: "ttl",
                pointInTimeRecovery: true,
                encryption: dynamodb.TableEncryption.AWS_MANAGED,
            });
            const rateLimitName = this.rateLimitTable.tableName;
            env.APPTHEORY_RATE_LIMIT_TABLE_NAME = rateLimitName;
            env.RATE_LIMIT_TABLE_NAME = rateLimitName;
            env.RATE_LIMIT_TABLE = rateLimitName;
            env.LIMITED_TABLE_NAME = rateLimitName;
        }
        this.fn = new function_1.AppTheoryFunction(this, "Function", {
            functionName: appName,
            runtime: props.runtime ?? lambda.Runtime.PROVIDED_AL2023,
            handler: props.handler ?? "bootstrap",
            code,
            environment: env,
            memorySize: props.memorySize,
            timeout: aws_cdk_lib_1.Duration.seconds(props.timeoutSeconds ?? 30),
        });
        if (this.databaseTable) {
            this.databaseTable.grantReadWriteData(this.fn.fn);
        }
        if (this.rateLimitTable) {
            this.rateLimitTable.grantReadWriteData(this.fn.fn);
        }
        this.api = new http_api_1.AppTheoryHttpApi(this, "API", {
            handler: this.fn.fn,
            apiName: `${appName}-api`,
        });
        if (props.domainName || props.certificateArn) {
            if (!props.domainName || !props.certificateArn) {
                throw new Error("AppTheoryApp requires both props.domainName and props.certificateArn for custom domain");
            }
            const cert = acm.Certificate.fromCertificateArn(this, "Certificate", props.certificateArn);
            this.domain = new api_domain_1.AppTheoryApiDomain(this, "Domain", {
                domainName: props.domainName,
                certificate: cert,
                httpApi: this.api.api,
                stage: props.stage ?? this.api.api.defaultStage,
                hostedZone: props.hostedZone,
            });
        }
        const stack = aws_cdk_lib_1.Stack.of(this);
        new aws_cdk_lib_1.CfnOutput(stack, "ApiUrl", {
            value: this.api.api.url ?? "",
            description: "API Gateway endpoint URL",
        });
        new aws_cdk_lib_1.CfnOutput(stack, "FunctionName", {
            value: this.fn.fn.functionName,
            description: "Lambda function name",
        });
        if (this.databaseTable) {
            new aws_cdk_lib_1.CfnOutput(stack, "DatabaseTableName", {
                value: this.databaseTable.tableName,
                description: "DynamoDB table name",
            });
        }
    }
}
exports.AppTheoryApp = AppTheoryApp;
_a = JSII_RTTI_SYMBOL_1;
AppTheoryApp[_a] = { fqn: "@theory-cloud/apptheory-cdk.AppTheoryApp", version: "0.3.1" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNkNBQXlEO0FBRXpELDBEQUEwRDtBQUMxRCxxREFBcUQ7QUFDckQsaURBQWlEO0FBRWpELDJDQUF1QztBQUV2Qyw2Q0FBa0Q7QUFDbEQseUNBQStDO0FBQy9DLHlDQUE4QztBQTRCOUMsTUFBYSxZQUFhLFNBQVEsc0JBQVM7SUFPekMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF3QjtRQUNoRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ25ELElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNiLE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBRUQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsTUFBTSxJQUFJLEtBQUssQ0FBQyxnRUFBZ0UsQ0FBQyxDQUFDO1FBQ3BGLENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBMkIsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBRXJFLElBQUksS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQztZQUN6QyxHQUFHLENBQUMsY0FBYyxHQUFHLElBQUksQ0FB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QUUsS0FBSyxDQUFDLFVBQVU7YUFDN0IsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sS0FBSyxHQUFHLG1CQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTdCLElBQUksdUJBQVMsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFO1lBQzdCLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksRUFBRTtZQUM3QixXQUFXLEVBQUUsMEJBQTBCO1NBQ3hDLENBQUMsQ0FBQztRQUVILElBQUksdUJBQVMsQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFO1lBQ25DLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxZQUFZO1lBQzlCLFdBQVcsRUFBRSxzQkFBc0I7U0FDcEMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDdkIsSUFBSSx1QkFBUyxDQUFDLEtBQUssRUFBRSxtQkFBbUIsRUFBRTtnQkFDeEMsS0FBSyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUztnQkFDbkMsV0FBVyxFQUFFLHFCQUFxQjthQUNuQyxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQzs7QUF6SEgsb0NBMEhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2ZuT3V0cHV0LCBEdXJhdGlvbiwgU3RhY2sgfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGFwaWd3djIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5djJcIjtcbmltcG9ydCAqIGFzIGFjbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNlcnRpZmljYXRlbWFuYWdlclwiO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1keW5hbW9kYlwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgdHlwZSAqIGFzIHJvdXRlNTMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuXG5pbXBvcnQgeyBBcHBUaGVvcnlBcGlEb21haW4gfSBmcm9tIFwiLi9hcGktZG9tYWluXCI7XG5pbXBvcnQgeyBBcHBUaGVvcnlGdW5jdGlvbiB9IGZyb20gXCIuL2Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBBcHBUaGVvcnlIdHRwQXBpIH0gZnJvbSBcIi4vaHR0cC1hcGlcIjtcblxuZXhwb3J0IGludGVyZmFjZSBBcHBUaGVvcnlBcHBQcm9wcyB7XG4gIHJlYWRvbmx5IGFwcE5hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgY29kZUFzc2V0UGF0aD86IHN0cmluZztcbiAgcmVhZG9ubHkgY29kZT86IGxhbWJkYS5Db2RlO1xuICByZWFkb25seSBydW50aW1lPzogbGFtYmRhLlJ1bnRpbWU7XG4gIHJlYWRvbmx5IGhhbmRsZXI/OiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkgZW52aXJvbm1lbnQ/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICByZWFkb25seSBtZW1vcnlTaXplPzogbnVtYmVyO1xuICByZWFkb25seSB0aW1lb3V0U2Vjb25kcz86IG51bWJlcjtcblxuICByZWFkb25seSBlbmFibGVEYXRhYmFzZT86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGRhdGFiYXNlVGFibGVOYW1lPzogc3RyaW5nO1xuICByZWFkb25seSBkYXRhYmFzZVBhcnRpdGlvbktleT86IHN0cmluZztcbiAgcmVhZG9ubHkgZGF0YWJhc2VTb3J0S2V5Pzogc3RyaW5nO1xuICByZWFkb25seSBkYXRhYmFzZVRhYmxlPzogZHluYW1vZGIuSVRhYmxlO1xuXG4gIHJlYWRvbmx5IGVuYWJsZVJhdGVMaW1pdGluZz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IHJhdGVMaW1pdFRhYmxlTmFtZT86IHN0cmluZztcblxuICByZWFkb25seSBkb21haW5OYW1lPzogc3RyaW5nO1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZUFybj86IHN0cmluZztcbiAgcmVhZG9ubHkgaG9zdGVkWm9uZT86IHJvdXRlNTMuSUhvc3RlZFpvbmU7XG4gIHJlYWRvbmx5IHN0YWdlPzogYXBpZ3d2Mi5JU3RhZ2U7XG59XG5cbmV4cG9ydCBjbGFzcyBBcHBUaGVvcnlBcHAgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgYXBpOiBBcHBUaGVvcnlIdHRwQXBpO1xuICBwdWJsaWMgcmVhZG9ubHkgZm46IEFwcFRoZW9yeUZ1bmN0aW9uO1xuICBwdWJsaWMgcmVhZG9ubHkgZGF0YWJhc2VUYWJsZT86IGR5bmFtb2RiLklUYWJsZTtcbiAgcHVibGljIHJlYWRvbmx5IHJhdGVMaW1pdFRhYmxlPzogZHluYW1vZGIuSVRhYmxlO1xuICBwdWJsaWMgcmVhZG9ubHkgZG9tYWluPzogQXBwVGhlb3J5QXBpRG9tYWluO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBBcHBUaGVvcnlBcHBQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBhcHBOYW1lID0gU3RyaW5nKHByb3BzLmFwcE5hbWUgPz8gXCJcIikudHJpbSgpO1xuICAgIGlmICghYXBwTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXBwVGhlb3J5QXBwIHJlcXVpcmVzIHByb3BzLmFwcE5hbWVcIik7XG4gICAgfVxuXG4gICAgY29uc3QgY29kZSA9IHByb3BzLmNvZGUgPz8gKHByb3BzLmNvZGVBc3NldFBhdGggPyBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocHJvcHMuY29kZUFzc2V0UGF0aCkgOiB1bmRlZmluZWQpO1xuICAgIGlmICghY29kZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXBwVGhlb3J5QXBwIHJlcXVpcmVzIGVpdGhlciBwcm9wcy5jb2RlIG9yIHByb3BzLmNvZGVBc3NldFBhdGhcIik7XG4gICAgfVxuXG4gICAgY29uc3QgZW52OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0geyAuLi4ocHJvcHMuZW52aXJvbm1lbnQgPz8ge30pIH07XG5cbiAgICBpZiAocHJvcHMuZGF0YWJhc2VUYWJsZSkge1xuICAgICAgdGhpcy5kYXRhYmFzZVRhYmxlID0gcHJvcHMuZGF0YWJhc2VUYWJsZTtcbiAgICAgIGVudi5EWU5BTU9EQl9UQUJMRSA9IHRoaXMuZGF0YWJhc2VUYWJsZS50YWJsZU5hbWU7XG4gICAgfSBlbHNlIGlmIChwcm9wcy5lbmFibGVEYXRhYmFzZSkge1xuICAgICAgY29uc3QgdGFibGVOYW1lID0gcHJvcHMuZGF0YWJhc2VUYWJsZU5hbWUgPz8gYCR7YXBwTmFtZX0tdGFibGVgO1xuICAgICAgY29uc3QgcGFydGl0aW9uS2V5TmFtZSA9IHByb3BzLmRhdGFiYXNlUGFydGl0aW9uS2V5ID8/IFwiSURcIjtcblxuICAgICAgdGhpcy5kYXRhYmFzZVRhYmxlID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsIFwiRGF0YWJhc2VcIiwge1xuICAgICAgICB0YWJsZU5hbWUsXG4gICAgICAgIGJpbGxpbmdNb2RlOiBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsXG4gICAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBwYXJ0aXRpb25LZXlOYW1lLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgICBzb3J0S2V5OiBwcm9wcy5kYXRhYmFzZVNvcnRLZXlcbiAgICAgICAgICA/IHsgbmFtZTogcHJvcHMuZGF0YWJhc2VTb3J0S2V5LCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9XG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIHRpbWVUb0xpdmVBdHRyaWJ1dGU6IFwidHRsXCIsXG4gICAgICAgIHBvaW50SW5UaW1lUmVjb3Zlcnk6IHRydWUsXG4gICAgICAgIGVuY3J5cHRpb246IGR5bmFtb2RiLlRhYmxlRW5jcnlwdGlvbi5BV1NfTUFOQUdFRCxcbiAgICAgICAgc3RyZWFtOiBkeW5hbW9kYi5TdHJlYW1WaWV3VHlwZS5ORVdfQU5EX09MRF9JTUFHRVMsXG4gICAgICB9KTtcblxuICAgICAgZW52LkRZTkFNT0RCX1RBQkxFID0gdGhpcy5kYXRhYmFzZVRhYmxlLnRhYmxlTmFtZTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMuZW5hYmxlUmF0ZUxpbWl0aW5nKSB7XG4gICAgICBjb25zdCB0YWJsZU5hbWUgPSBwcm9wcy5yYXRlTGltaXRUYWJsZU5hbWUgPz8gYCR7YXBwTmFtZX0tcmF0ZS1saW1pdHNgO1xuXG4gICAgICB0aGlzLnJhdGVMaW1pdFRhYmxlID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsIFwiUmF0ZUxpbWl0VGFibGVcIiwge1xuICAgICAgICB0YWJsZU5hbWUsXG4gICAgICAgIGJpbGxpbmdNb2RlOiBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsXG4gICAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcInBrXCIsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICAgIHNvcnRLZXk6IHsgbmFtZTogXCJza1wiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgICB0aW1lVG9MaXZlQXR0cmlidXRlOiBcInR0bFwiLFxuICAgICAgICBwb2ludEluVGltZVJlY292ZXJ5OiB0cnVlLFxuICAgICAgICBlbmNyeXB0aW9uOiBkeW5hbW9kYi5UYWJsZUVuY3J5cHRpb24uQVdTX01BTkFHRUQsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmF0ZUxpbWl0TmFtZSA9IHRoaXMucmF0ZUxpbWl0VGFibGUudGFibGVOYW1lO1xuICAgICAgZW52LkFQUFRIRU9SWV9SQVRFX0xJTUlUX1RBQkxFX05BTUUgPSByYXRlTGltaXROYW1lO1xuICAgICAgZW52LlJBVEVfTElNSVRfVEFCTEVfTkFNRSA9IHJhdGVMaW1pdE5hbWU7XG4gICAgICBlbnYuUkFURV9MSU1JVF9UQUJMRSA9IHJhdGVMaW1pdE5hbWU7XG4gICAgICBlbnYuTElNSVRFRF9UQUJMRV9OQU1FID0gcmF0ZUxpbWl0TmFtZTtcbiAgICB9XG5cbiAgICB0aGlzLmZuID0gbmV3IEFwcFRoZW9yeUZ1bmN0aW9uKHRoaXMsIFwiRnVuY3Rpb25cIiwge1xuICAgICAgZnVuY3Rpb25OYW1lOiBhcHBOYW1lLFxuICAgICAgcnVudGltZTogcHJvcHMucnVudGltZSA/PyBsYW1iZGEuUnVudGltZS5QUk9WSURFRF9BTDIwMjMsXG4gICAgICBoYW5kbGVyOiBwcm9wcy5oYW5kbGVyID8/IFwiYm9vdHN0cmFwXCIsXG4gICAgICBjb2RlLFxuICAgICAgZW52aXJvbm1lbnQ6IGVudixcbiAgICAgIG1lbW9yeVNpemU6IHByb3BzLm1lbW9yeVNpemUsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKHByb3BzLnRpbWVvdXRTZWNvbmRzID8/IDMwKSxcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLmRhdGFiYXNlVGFibGUpIHtcbiAgICAgIHRoaXMuZGF0YWJhc2VUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEodGhpcy5mbi5mbik7XG4gICAgfVxuICAgIGlmICh0aGlzLnJhdGVMaW1pdFRhYmxlKSB7XG4gICAgICB0aGlzLnJhdGVMaW1pdFRhYmxlLmdyYW50UmVhZFdyaXRlRGF0YSh0aGlzLmZuLmZuKTtcbiAgICB9XG5cbiAgICB0aGlzLmFwaSA9IG5ldyBBcHBUaGVvcnlIdHRwQXBpKHRoaXMsIFwiQVBJXCIsIHtcbiAgICAgIGhhbmRsZXI6IHRoaXMuZm4uZm4sXG4gICAgICBhcGlOYW1lOiBgJHthcHBOYW1lfS1hcGlgLFxuICAgIH0pO1xuXG4gICAgaWYgKHByb3BzLmRvbWFpbk5hbWUgfHwgcHJvcHMuY2VydGlmaWNhdGVBcm4pIHtcbiAgICAgIGlmICghcHJvcHMuZG9tYWluTmFtZSB8fCAhcHJvcHMuY2VydGlmaWNhdGVBcm4pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXBwVGhlb3J5QXBwIHJlcXVpcmVzIGJvdGggcHJvcHMuZG9tYWluTmFtZSBhbmQgcHJvcHMuY2VydGlmaWNhdGVBcm4gZm9yIGN1c3RvbSBkb21haW5cIik7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNlcnQgPSBhY20uQ2VydGlmaWNhdGUuZnJvbUNlcnRpZmljYXRlQXJuKHRoaXMsIFwiQ2VydGlmaWNhdGVcIiwgcHJvcHMuY2VydGlmaWNhdGVBcm4pO1xuXG4gICAgICB0aGlzLmRvbWFpbiA9IG5ldyBBcHBUaGVvcnlBcGlEb21haW4odGhpcywgXCJEb21haW5cIiwge1xuICAgICAgICBkb21haW5OYW1lOiBwcm9wcy5kb21haW5OYW1lLFxuICAgICAgICBjZXJ0aWZpY2F0ZTogY2VydCxcbiAgICAgICAgaHR0cEFwaTogdGhpcy5hcGkuYXBpLFxuICAgICAgICBzdGFnZTogcHJvcHMuc3RhZ2UgPz8gdGhpcy5hcGkuYXBpLmRlZmF1bHRTdGFnZSxcbiAgICAgICAgaG9zdGVkWm9uZTogcHJvcHMuaG9zdGVkWm9uZSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YWNrID0gU3RhY2sub2YodGhpcyk7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KHN0YWNrLCBcIkFwaVVybFwiLCB7XG4gICAgICB2YWx1ZTogdGhpcy5hcGkuYXBpLnVybCA/PyBcIlwiLFxuICAgICAgZGVzY3JpcHRpb246IFwiQVBJIEdhdGV3YXkgZW5kcG9pbnQgVVJMXCIsXG4gICAgfSk7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KHN0YWNrLCBcIkZ1bmN0aW9uTmFtZVwiLCB7XG4gICAgICB2YWx1ZTogdGhpcy5mbi5mbi5mdW5jdGlvbk5hbWUsXG4gICAgICBkZXNjcmlwdGlvbjogXCJMYW1iZGEgZnVuY3Rpb24gbmFtZVwiLFxuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuZGF0YWJhc2VUYWJsZSkge1xuICAgICAgbmV3IENmbk91dHB1dChzdGFjaywgXCJEYXRhYmFzZVRhYmxlTmFtZVwiLCB7XG4gICAgICAgIHZhbHVlOiB0aGlzLmRhdGFiYXNlVGFibGUudGFibGVOYW1lLFxuICAgICAgICBkZXNjcmlwdGlvbjogXCJEeW5hbW9EQiB0YWJsZSBuYW1lXCIsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==