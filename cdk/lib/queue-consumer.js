"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppTheoryQueueConsumer = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const lambda = require("aws-cdk-lib/aws-lambda");
const lambdaEventSources = require("aws-cdk-lib/aws-lambda-event-sources");
const constructs_1 = require("constructs");
/**
 * A composable SQS consumer construct that wires a Lambda function to an SQS queue.
 *
 * This construct creates an event source mapping between an SQS queue and a Lambda function,
 * with full control over batching, concurrency, and failure reporting.
 *
 * @example
 * // Basic consumer with default settings
 * new AppTheoryQueueConsumer(stack, 'Consumer', {
 *   queue: myQueue.queue,
 *   consumer: myFunction,
 * });
 *
 * @example
 * // Consumer with full configuration
 * new AppTheoryQueueConsumer(stack, 'Consumer', {
 *   queue: myQueue.queue,
 *   consumer: myFunction,
 *   batchSize: 100,
 *   maxBatchingWindow: Duration.seconds(10),
 *   reportBatchItemFailures: true,
 *   maxConcurrency: 50,
 * });
 */
class AppTheoryQueueConsumer extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.consumer = props.consumer;
        this.queue = props.queue;
        // Create the event source with all options
        const eventSource = new lambdaEventSources.SqsEventSource(props.queue, {
            batchSize: props.batchSize ?? 10,
            maxBatchingWindow: props.maxBatchingWindow,
            reportBatchItemFailures: props.reportBatchItemFailures,
            maxConcurrency: props.maxConcurrency,
            enabled: props.enabled !== false,
            filters: props.filters,
        });
        // Add the event source to the Lambda
        if (props.consumer instanceof lambda.Function) {
            props.consumer.addEventSource(eventSource);
        }
        else {
            // For IFunction, we need to use the abstract function pattern
            lambda.Function.fromFunctionArn(this, "ConsumerFn", props.consumer.functionArn);
            // Re-add with explicit cast since this is typically used with actual functions
            props.consumer.addEventSource(eventSource);
        }
        // Store the event source mapping for reference
        // Note: The eventSourceMapping is created internally by the SqsEventSource
        this.eventSourceMapping = eventSource.eventSourceMappingId
            ? eventSource.eventSourceMapping
            : {};
        // Grant consume permissions by default
        if (props.grantConsumeMessages !== false) {
            props.queue.grantConsumeMessages(props.consumer);
        }
    }
    /**
     * Disable the event source mapping.
     * This can be used for circuit breaker patterns.
     */
    disable() {
        // Note: Disabling at runtime requires updating the event source mapping
        // This is typically done through the AWS SDK or console
        console.warn("disable() is a deployment-time operation. Use 'enabled: false' in props for new deployments.");
    }
}
exports.AppTheoryQueueConsumer = AppTheoryQueueConsumer;
_a = JSII_RTTI_SYMBOL_1;
AppTheoryQueueConsumer[_a] = { fqn: "@theory-cloud/apptheory-cdk.AppTheoryQueueConsumer", version: "0.5.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVldWUtY29uc3VtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJxdWV1ZS1jb25zdW1lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLGlEQUFpRDtBQUNqRCwyRUFBMkU7QUFFM0UsMkNBQXVDO0FBNkR2Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFDSCxNQUFhLHNCQUF1QixTQUFRLHNCQUFTO0lBZ0JqRCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWtDO1FBQ3hFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQy9CLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUV6QiwyQ0FBMkM7UUFDM0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRTtZQUNuRSxTQUFTLEVBQUUsS0FBSyxDQUFDLFNBQVMsSUFBSSxFQUFFO1lBQ2hDLGlCQUFpQixFQUFFLEtBQUssQ0FBQyxpQkFBaUI7WUFDMUMsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLHVCQUF1QjtZQUN0RCxjQUFjLEVBQUUsS0FBSyxDQUFDLGNBQWM7WUFDcEMsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLEtBQUssS0FBSztZQUNoQyxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87U0FDekIsQ0FBQyxDQUFDO1FBRUgscUNBQXFDO1FBQ3JDLElBQUksS0FBSyxDQUFDLFFBQVEsWUFBWSxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDNUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDL0MsQ0FBQzthQUFNLENBQUM7WUFDSiw4REFBOEQ7WUFDOUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQzNCLElBQUksRUFDSixZQUFZLEVBQ1osS0FBSyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQzdCLENBQUM7WUFDRiwrRUFBK0U7WUFDOUUsS0FBSyxDQUFDLFFBQTRCLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFFRCwrQ0FBK0M7UUFDL0MsMkVBQTJFO1FBQzNFLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxXQUFXLENBQUMsb0JBQW9CO1lBQ3RELENBQUMsQ0FBRSxXQUE0RSxDQUFDLGtCQUFrQjtZQUNsRyxDQUFDLENBQUUsRUFBZ0MsQ0FBQztRQUV4Qyx1Q0FBdUM7UUFDdkMsSUFBSSxLQUFLLENBQUMsb0JBQW9CLEtBQUssS0FBSyxFQUFFLENBQUM7WUFDdkMsS0FBSyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDckQsQ0FBQztJQUNMLENBQUM7SUFFRDs7O09BR0c7SUFDSSxPQUFPO1FBQ1Ysd0VBQXdFO1FBQ3hFLHdEQUF3RDtRQUN4RCxPQUFPLENBQUMsSUFBSSxDQUFDLDhGQUE4RixDQUFDLENBQUM7SUFDakgsQ0FBQzs7QUFsRUwsd0RBbUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgbGFtYmRhRXZlbnRTb3VyY2VzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLWV2ZW50LXNvdXJjZXNcIjtcbmltcG9ydCB0eXBlICogYXMgc3FzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3FzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIEFwcFRoZW9yeVF1ZXVlQ29uc3VtZXIgY29uc3RydWN0LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFwcFRoZW9yeVF1ZXVlQ29uc3VtZXJQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVGhlIFNRUyBxdWV1ZSB0byBjb25zdW1lIG1lc3NhZ2VzIGZyb20uXG4gICAgICovXG4gICAgcmVhZG9ubHkgcXVldWU6IHNxcy5JUXVldWU7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgTGFtYmRhIGZ1bmN0aW9uIHRoYXQgd2lsbCBwcm9jZXNzIG1lc3NhZ2VzLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGNvbnN1bWVyOiBsYW1iZGEuSUZ1bmN0aW9uO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIHJlY29yZHMgdG8gcmV0cmlldmUgcGVyIGJhdGNoLlxuICAgICAqIEBkZWZhdWx0IDEwXG4gICAgICovXG4gICAgcmVhZG9ubHkgYmF0Y2hTaXplPzogbnVtYmVyO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG1heGltdW0gYW1vdW50IG9mIHRpbWUgdG8gd2FpdCBmb3IgYSBiYXRjaCB0byBiZSBnYXRoZXJlZC5cbiAgICAgKiBAZGVmYXVsdCAtIE5vIGJhdGNoaW5nIHdpbmRvdyAobWVzc2FnZXMgcHJvY2Vzc2VkIGltbWVkaWF0ZWx5KVxuICAgICAqL1xuICAgIHJlYWRvbmx5IG1heEJhdGNoaW5nV2luZG93PzogRHVyYXRpb247XG5cbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIHRvIHJlcG9ydCBiYXRjaCBpdGVtIGZhaWx1cmVzLlxuICAgICAqIFdoZW4gZW5hYmxlZCwgdGhlIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gYSBwYXJ0aWFsIGZhaWx1cmUgcmVzcG9uc2UuXG4gICAgICogQGRlZmF1bHQgZmFsc2VcbiAgICAgKi9cbiAgICByZWFkb25seSByZXBvcnRCYXRjaEl0ZW1GYWlsdXJlcz86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbWF4aW11bSBjb25jdXJyZW5jeSBzZXR0aW5nIGxpbWl0cyB0aGUgbnVtYmVyIG9mIGNvbmN1cnJlbnQgaW5zdGFuY2VzIG9mIHRoZSBmdW5jdGlvbi5cbiAgICAgKiBWYWxpZCByYW5nZTogMi0xMDAwLlxuICAgICAqIEBkZWZhdWx0IC0gTm8gY29uY3VycmVuY3kgbGltaXRcbiAgICAgKi9cbiAgICByZWFkb25seSBtYXhDb25jdXJyZW5jeT86IG51bWJlcjtcblxuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgdGhlIGV2ZW50IHNvdXJjZSBtYXBwaW5nIGlzIGVuYWJsZWQuXG4gICAgICogQGRlZmF1bHQgdHJ1ZVxuICAgICAqL1xuICAgIHJlYWRvbmx5IGVuYWJsZWQ/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogV2hldGhlciB0byBhdXRvbWF0aWNhbGx5IGdyYW50IGNvbnN1bWUgcGVybWlzc2lvbnMgdG8gdGhlIExhbWJkYSBmdW5jdGlvbi5cbiAgICAgKiBAZGVmYXVsdCB0cnVlXG4gICAgICovXG4gICAgcmVhZG9ubHkgZ3JhbnRDb25zdW1lTWVzc2FnZXM/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwgZmlsdGVycyB0byBjb250cm9sIHdoaWNoIG1lc3NhZ2VzIHRyaWdnZXIgdGhlIExhbWJkYS5cbiAgICAgKiBAZGVmYXVsdCAtIEFsbCBtZXNzYWdlcyB0cmlnZ2VyIHRoZSBMYW1iZGFcbiAgICAgKi9cbiAgICByZWFkb25seSBmaWx0ZXJzPzogbGFtYmRhLkZpbHRlckNyaXRlcmlhW107XG59XG5cbi8qKlxuICogQSBjb21wb3NhYmxlIFNRUyBjb25zdW1lciBjb25zdHJ1Y3QgdGhhdCB3aXJlcyBhIExhbWJkYSBmdW5jdGlvbiB0byBhbiBTUVMgcXVldWUuXG4gKlxuICogVGhpcyBjb25zdHJ1Y3QgY3JlYXRlcyBhbiBldmVudCBzb3VyY2UgbWFwcGluZyBiZXR3ZWVuIGFuIFNRUyBxdWV1ZSBhbmQgYSBMYW1iZGEgZnVuY3Rpb24sXG4gKiB3aXRoIGZ1bGwgY29udHJvbCBvdmVyIGJhdGNoaW5nLCBjb25jdXJyZW5jeSwgYW5kIGZhaWx1cmUgcmVwb3J0aW5nLlxuICpcbiAqIEBleGFtcGxlXG4gKiAvLyBCYXNpYyBjb25zdW1lciB3aXRoIGRlZmF1bHQgc2V0dGluZ3NcbiAqIG5ldyBBcHBUaGVvcnlRdWV1ZUNvbnN1bWVyKHN0YWNrLCAnQ29uc3VtZXInLCB7XG4gKiAgIHF1ZXVlOiBteVF1ZXVlLnF1ZXVlLFxuICogICBjb25zdW1lcjogbXlGdW5jdGlvbixcbiAqIH0pO1xuICpcbiAqIEBleGFtcGxlXG4gKiAvLyBDb25zdW1lciB3aXRoIGZ1bGwgY29uZmlndXJhdGlvblxuICogbmV3IEFwcFRoZW9yeVF1ZXVlQ29uc3VtZXIoc3RhY2ssICdDb25zdW1lcicsIHtcbiAqICAgcXVldWU6IG15UXVldWUucXVldWUsXG4gKiAgIGNvbnN1bWVyOiBteUZ1bmN0aW9uLFxuICogICBiYXRjaFNpemU6IDEwMCxcbiAqICAgbWF4QmF0Y2hpbmdXaW5kb3c6IER1cmF0aW9uLnNlY29uZHMoMTApLFxuICogICByZXBvcnRCYXRjaEl0ZW1GYWlsdXJlczogdHJ1ZSxcbiAqICAgbWF4Q29uY3VycmVuY3k6IDUwLFxuICogfSk7XG4gKi9cbmV4cG9ydCBjbGFzcyBBcHBUaGVvcnlRdWV1ZUNvbnN1bWVyIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgICAvKipcbiAgICAgKiBUaGUgZXZlbnQgc291cmNlIG1hcHBpbmcuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGV2ZW50U291cmNlTWFwcGluZzogbGFtYmRhLkV2ZW50U291cmNlTWFwcGluZztcblxuICAgIC8qKlxuICAgICAqIFRoZSBjb25zdW1lciBMYW1iZGEgZnVuY3Rpb24uXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGNvbnN1bWVyOiBsYW1iZGEuSUZ1bmN0aW9uO1xuXG4gICAgLyoqXG4gICAgICogVGhlIFNRUyBxdWV1ZSBiZWluZyBjb25zdW1lZC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgcXVldWU6IHNxcy5JUXVldWU7XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQXBwVGhlb3J5UXVldWVDb25zdW1lclByb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAgICAgdGhpcy5jb25zdW1lciA9IHByb3BzLmNvbnN1bWVyO1xuICAgICAgICB0aGlzLnF1ZXVlID0gcHJvcHMucXVldWU7XG5cbiAgICAgICAgLy8gQ3JlYXRlIHRoZSBldmVudCBzb3VyY2Ugd2l0aCBhbGwgb3B0aW9uc1xuICAgICAgICBjb25zdCBldmVudFNvdXJjZSA9IG5ldyBsYW1iZGFFdmVudFNvdXJjZXMuU3FzRXZlbnRTb3VyY2UocHJvcHMucXVldWUsIHtcbiAgICAgICAgICAgIGJhdGNoU2l6ZTogcHJvcHMuYmF0Y2hTaXplID8/IDEwLFxuICAgICAgICAgICAgbWF4QmF0Y2hpbmdXaW5kb3c6IHByb3BzLm1heEJhdGNoaW5nV2luZG93LFxuICAgICAgICAgICAgcmVwb3J0QmF0Y2hJdGVtRmFpbHVyZXM6IHByb3BzLnJlcG9ydEJhdGNoSXRlbUZhaWx1cmVzLFxuICAgICAgICAgICAgbWF4Q29uY3VycmVuY3k6IHByb3BzLm1heENvbmN1cnJlbmN5LFxuICAgICAgICAgICAgZW5hYmxlZDogcHJvcHMuZW5hYmxlZCAhPT0gZmFsc2UsXG4gICAgICAgICAgICBmaWx0ZXJzOiBwcm9wcy5maWx0ZXJzLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBBZGQgdGhlIGV2ZW50IHNvdXJjZSB0byB0aGUgTGFtYmRhXG4gICAgICAgIGlmIChwcm9wcy5jb25zdW1lciBpbnN0YW5jZW9mIGxhbWJkYS5GdW5jdGlvbikge1xuICAgICAgICAgICAgcHJvcHMuY29uc3VtZXIuYWRkRXZlbnRTb3VyY2UoZXZlbnRTb3VyY2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gRm9yIElGdW5jdGlvbiwgd2UgbmVlZCB0byB1c2UgdGhlIGFic3RyYWN0IGZ1bmN0aW9uIHBhdHRlcm5cbiAgICAgICAgICAgIGxhbWJkYS5GdW5jdGlvbi5mcm9tRnVuY3Rpb25Bcm4oXG4gICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICBcIkNvbnN1bWVyRm5cIixcbiAgICAgICAgICAgICAgICBwcm9wcy5jb25zdW1lci5mdW5jdGlvbkFybixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICAvLyBSZS1hZGQgd2l0aCBleHBsaWNpdCBjYXN0IHNpbmNlIHRoaXMgaXMgdHlwaWNhbGx5IHVzZWQgd2l0aCBhY3R1YWwgZnVuY3Rpb25zXG4gICAgICAgICAgICAocHJvcHMuY29uc3VtZXIgYXMgbGFtYmRhLkZ1bmN0aW9uKS5hZGRFdmVudFNvdXJjZShldmVudFNvdXJjZSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTdG9yZSB0aGUgZXZlbnQgc291cmNlIG1hcHBpbmcgZm9yIHJlZmVyZW5jZVxuICAgICAgICAvLyBOb3RlOiBUaGUgZXZlbnRTb3VyY2VNYXBwaW5nIGlzIGNyZWF0ZWQgaW50ZXJuYWxseSBieSB0aGUgU3FzRXZlbnRTb3VyY2VcbiAgICAgICAgdGhpcy5ldmVudFNvdXJjZU1hcHBpbmcgPSBldmVudFNvdXJjZS5ldmVudFNvdXJjZU1hcHBpbmdJZFxuICAgICAgICAgICAgPyAoZXZlbnRTb3VyY2UgYXMgdW5rbm93biBhcyB7IGV2ZW50U291cmNlTWFwcGluZzogbGFtYmRhLkV2ZW50U291cmNlTWFwcGluZyB9KS5ldmVudFNvdXJjZU1hcHBpbmdcbiAgICAgICAgICAgIDogKHt9IGFzIGxhbWJkYS5FdmVudFNvdXJjZU1hcHBpbmcpO1xuXG4gICAgICAgIC8vIEdyYW50IGNvbnN1bWUgcGVybWlzc2lvbnMgYnkgZGVmYXVsdFxuICAgICAgICBpZiAocHJvcHMuZ3JhbnRDb25zdW1lTWVzc2FnZXMgIT09IGZhbHNlKSB7XG4gICAgICAgICAgICBwcm9wcy5xdWV1ZS5ncmFudENvbnN1bWVNZXNzYWdlcyhwcm9wcy5jb25zdW1lcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEaXNhYmxlIHRoZSBldmVudCBzb3VyY2UgbWFwcGluZy5cbiAgICAgKiBUaGlzIGNhbiBiZSB1c2VkIGZvciBjaXJjdWl0IGJyZWFrZXIgcGF0dGVybnMuXG4gICAgICovXG4gICAgcHVibGljIGRpc2FibGUoKTogdm9pZCB7XG4gICAgICAgIC8vIE5vdGU6IERpc2FibGluZyBhdCBydW50aW1lIHJlcXVpcmVzIHVwZGF0aW5nIHRoZSBldmVudCBzb3VyY2UgbWFwcGluZ1xuICAgICAgICAvLyBUaGlzIGlzIHR5cGljYWxseSBkb25lIHRocm91Z2ggdGhlIEFXUyBTREsgb3IgY29uc29sZVxuICAgICAgICBjb25zb2xlLndhcm4oXCJkaXNhYmxlKCkgaXMgYSBkZXBsb3ltZW50LXRpbWUgb3BlcmF0aW9uLiBVc2UgJ2VuYWJsZWQ6IGZhbHNlJyBpbiBwcm9wcyBmb3IgbmV3IGRlcGxveW1lbnRzLlwiKTtcbiAgICB9XG59XG4iXX0=